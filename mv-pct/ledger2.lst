21:49:34 SQL> @@preledger.sql
21:49:34 SQL> REM preledger.sql
21:49:34 SQL> clear screen
21:49:34 SQL> connect scott/tiger@oracle_pdb
Connected.
21:49:34 SQL> set time on timi on autotrace off pages 99 lines 200 trimspool on echo on
21:49:34 SQL> alter session set nls_date_Format = 'hh24:mi:ss dd/mm/yyyy';

Session altered.

Elapsed: 00:00:00.00
21:49:34 SQL> drop table ps_ledger purge;

Table dropped.

Elapsed: 00:00:00.42
21:49:35 SQL> drop materialized view mv_ledger_2019;
drop materialized view mv_ledger_2019
*
ERROR at line 1:
ORA-12003: materialized view or zonemap "SCOTT"."MV_LEDGER_2019" does not exist


Elapsed: 00:00:00.01
21:49:35 SQL> drop table mv_ledger_2019 purge;
drop table mv_ledger_2019 purge
           *
ERROR at line 1:
ORA-00942: table or view does not exist


Elapsed: 00:00:00.00
21:49:35 SQL> drop materialized view mv_ledger_2020;

Materialized view dropped.

Elapsed: 00:00:00.15
21:49:35 SQL> drop table mv_ledger_2020 purge;
drop table mv_ledger_2020 purge
           *
ERROR at line 1:
ORA-00942: table or view does not exist


Elapsed: 00:00:00.00
21:49:35 SQL> DROP TABLE PSTREESELECT05 PURGE;

Table dropped.

Elapsed: 00:00:00.07
21:49:35 SQL> DROP TABLE PSTREESELECT10 PURGE;

Table dropped.

Elapsed: 00:00:00.25
21:49:35 SQL> purge recyclebin;

Recyclebin purged.

Elapsed: 00:00:00.00
21:49:35 SQL> 
21:49:35 SQL> CREATE TABLE ps_ledger
21:49:35   2  (business_unit VARCHAR2(5) NOT NULL
21:49:35   3  ,ledger VARCHAR2(10) NOT NULL
21:49:35   4  ,account VARCHAR2(10) NOT NULL
21:49:35   5  ,altacct VARCHAR2(10) NOT NULL
21:49:35   6  ,deptid VARCHAR2(10) NOT NULL
21:49:35   7  ,operating_unit VARCHAR2(8) NOT NULL
21:49:35   8  ,product VARCHAR2(6) NOT NULL
21:49:35   9  ,fund_code VARCHAR2(5) NOT NULL
21:49:35  10  ,class_fld VARCHAR2(5) NOT NULL
21:49:35  11  ,program_code VARCHAR2(5) NOT NULL
21:49:35  12  ,budget_ref VARCHAR2(8) NOT NULL
21:49:35  13  ,affiliate VARCHAR2(5) NOT NULL
21:49:35  14  ,affiliate_intra1 VARCHAR2(10) NOT NULL
21:49:35  15  ,affiliate_intra2 VARCHAR2(10) NOT NULL
21:49:35  16  ,chartfield1 VARCHAR2(10) NOT NULL
21:49:35  17  ,chartfield2 VARCHAR2(10) NOT NULL
21:49:35  18  ,chartfield3 VARCHAR2(10) NOT NULL
21:49:35  19  ,project_id VARCHAR2(15) NOT NULL
21:49:35  20  ,book_code VARCHAR2(4) NOT NULL
21:49:35  21  ,gl_adjust_type VARCHAR2(4) NOT NULL
21:49:35  22  ,currency_cd VARCHAR2(3) NOT NULL
21:49:35  23  ,statistics_code VARCHAR2(3) NOT NULL
21:49:35  24  ,fiscal_year SMALLINT NOT NULL
21:49:35  25  ,accounting_period SMALLINT NOT NULL
21:49:35  26  ,posted_total_amt DECIMAL(26,3) NOT NULL
21:49:35  27  ,posted_base_amt DECIMAL(26,3) NOT NULL
21:49:35  28  ,posted_tran_amt DECIMAL(26,3) NOT NULL
21:49:35  29  ,base_currency VARCHAR2(3) NOT NULL
21:49:35  30  ,dttm_stamp_sec TIMESTAMP
21:49:35  31  ,process_instance DECIMAL(10) NOT NULL
21:49:35  32  ) PCTFREE 10 PCTUSED 80
21:49:35  33  PARTITION BY RANGE (FISCAL_YEAR)
21:49:35  34  (PARTITION ledger_2018 VALUES LESS THAN (2019) PCTFREE 0 COMPRESS
21:49:35  35  ,PARTITION ledger_2019 VALUES LESS THAN (2020) PCTFREE 0 COMPRESS
21:49:35  36  ,PARTITION ledger_2020 VALUES LESS THAN (2021) PCTFREE 10 NOCOMPRESS
21:49:35  37  ,PARTITION ledger_2021 VALUES LESS THAN (2022) PCTFREE 10 NOCOMPRESS)
21:49:35  38  ENABLE ROW MOVEMENT NOLOGGING
21:49:35  39  /

Table created.

Elapsed: 00:00:00.12
21:49:35 SQL> @treeselectors
21:49:35 SQL> REM treeselectors.sql
21:49:35 SQL> 
21:49:35 SQL> DROP TABLE PSTREESELECT05 PURGE;
DROP TABLE PSTREESELECT05 PURGE
           *
ERROR at line 1:
ORA-00942: table or view does not exist


Elapsed: 00:00:00.00
21:49:35 SQL> CREATE TABLE PSTREESELECT05
21:49:35   2  (SELECTOR_NUM INTEGER NOT NULL,
21:49:35   3   TREE_NODE_NUM INTEGER NOT NULL,
21:49:35   4   RANGE_FROM_05 VARCHAR2(05) NOT NULL,
21:49:35   5   RANGE_TO_05   VARCHAR2(05) NOT NULL)
21:49:35   6   PARTITION BY RANGE (SELECTOR_NUM) INTERVAL (1)
21:49:35   7   (PARTITION pstreeselector VALUES LESS THAN (2))
21:49:35   8   NOPARALLEL NOLOGGING;

Table created.

Elapsed: 00:00:00.03
21:49:36 SQL> CREATE UNIQUE INDEX PS_PSTREESELECT05 ON PSTREESELECT05 (SELECTOR_NUM, TREE_NODE_NUM, RANGE_FROM_05);

Index created.

Elapsed: 00:00:00.02
21:49:36 SQL> 
21:49:36 SQL> DROP TABLE PSTREESELECT10 PURGE;
DROP TABLE PSTREESELECT10 PURGE
           *
ERROR at line 1:
ORA-00942: table or view does not exist


Elapsed: 00:00:00.00
21:49:36 SQL> CREATE TABLE PSTREESELECT10
21:49:36   2  (SELECTOR_NUM INTEGER NOT NULL,
21:49:36   3   TREE_NODE_NUM INTEGER NOT NULL,
21:49:36   4   RANGE_FROM_10 VARCHAR2(10) NOT NULL,
21:49:36   5   RANGE_TO_10   VARCHAR2(10) NOT NULL)
21:49:36   6   PARTITION BY RANGE (SELECTOR_NUM) INTERVAL (1)
21:49:36   7   (PARTITION pstreeselector VALUES LESS THAN (2))
21:49:36   8   NOPARALLEL NOLOGGING;

Table created.

Elapsed: 00:00:00.02
21:49:36 SQL> CREATE UNIQUE INDEX PS_PSTREESELECT10 ON PSTREESELECT10 (SELECTOR_NUM, TREE_NODE_NUM, RANGE_FROM_10);

Index created.

Elapsed: 00:00:00.02
21:49:36 SQL> 
21:49:36 SQL> exec dbms_stats.set_table_prefs('SCOTT','PSTREESELECT05','GRANULARITY','ALL');

PL/SQL procedure successfully completed.

Elapsed: 00:00:00.02
21:49:36 SQL> exec dbms_stats.set_table_prefs('SCOTT','PSTREESELECT10','GRANULARITY','ALL');

PL/SQL procedure successfully completed.

Elapsed: 00:00:00.01
21:49:36 SQL> exec dbms_stats.set_table_prefs('SCOTT','PSTREESELECT05','METHOD_OPT','FOR ALL COLUMNS SIZE 1, FOR COLUMNS SELECTOR_NUM, (SELECTOR_NUM, TREE_NODE_NUM) SIZE 254');

PL/SQL procedure successfully completed.

Elapsed: 00:00:00.05
21:49:36 SQL> exec dbms_stats.set_table_prefs('SCOTT','PSTREESELECT10','METHOD_OPT','FOR ALL COLUMNS SIZE 1, FOR COLUMNS SELECTOR_NUM, (SELECTOR_NUM, TREE_NODE_NUM) SIZE 254');

PL/SQL procedure successfully completed.

Elapsed: 00:00:00.03
21:49:36 SQL> 
21:49:36 SQL> @popledger
21:49:36 SQL> REM popledger.sql
21:49:36 SQL> set autotrace off echo on pages 99 lines 200 trimspool on
21:49:36 SQL> 
21:49:36 SQL> truncate table ps_ledger;

Table truncated.

Elapsed: 00:00:00.01
21:49:36 SQL> exec dbms_stats.set_table_prefs('SCOTT','PS_LEDGER','METHOD_OPT','FOR ALL COLUMNS SIZE 1, FOR COLUMNS FISCAL_YEAR, ACCOUNTING_PERIOD, LEDGER, BUSINESS_UNIT SIZE 254');

PL/SQL procedure successfully completed.

Elapsed: 00:00:00.01
21:49:36 SQL> exec dbms_stats.set_table_prefs('SCOTT','PS_LEDGER','GRANULARITY','ALL');

PL/SQL procedure successfully completed.

Elapsed: 00:00:00.01
21:49:36 SQL> 
21:49:36 SQL> ALTER TABLE PS_LEDGER PARALLEL 8;

Table altered.

Elapsed: 00:00:00.02
21:49:36 SQL> 
21:49:36 SQL> insert /*+APPEND PARALLEL ENABLE_PARALLEL_DML*/ into ps_ledger
21:49:36   2  with n as (
21:49:36   3  SELECT rownum n from dual connect by level <= 1e2
21:49:36   4  ), fy as (
21:49:36   5  SELECT /*+MATERIALIZE*/ 2017+rownum fiscal_year FROM dual CONNECT BY level <= 4
21:49:36   6  ), ap as (
21:49:36   7  SELECT /*+MATERIALIZE*/ FLOOR(dbms_random.value(0,13)) accounting_period FROM dual connect by level <= 998
21:49:36   8  UNION ALL SELECT 998 FROM DUAL CONNECT BY LEVEL <= 1
21:49:36   9  UNION ALL SELECT 999 FROM DUAL CONNECT BY LEVEL <= 1
21:49:36  10  ), l as (
21:49:36  11  SELECT /*+MATERIALIZE*/ 'ACTUALS' ledger FROM DUAL CONNECT BY LEVEL <= 10
21:49:36  12  UNION ALL SELECT 'BUDGET' FROM DUAL
21:49:36  13  )
21:49:36  14  select 'BU'||LTRIM(TO_CHAR(CASE WHEN dbms_random.value <= .9 THEN 1 ELSE 2 END,'000')) business_unit
21:49:36  15  ,      l.ledger
21:49:36  16  ,      'ACC'||LTRIM(TO_CHAR(999*SQRT(dbms_random.value),'000')) account
21:49:36  17  ,      'ALTACCT'||LTRIM(TO_CHAR(999*dbms_random.value,'000')) altacct
21:49:36  18  ,      'DEPT'||LTRIM(TO_CHAR(9999*dbms_random.value,'0000')) deptid
21:49:36  19  ,      'OPUNIT'||LTRIM(TO_CHAR(99*dbms_random.value,'00')) operating_unit
21:49:36  20  ,      'P'||LTRIM(TO_CHAR(99999*dbms_random.value,'00000')) product
21:49:36  21  ,      'FUND'||LTRIM(TO_CHAR(9*dbms_random.value,'0')) fund_code
21:49:36  22  ,      'CLAS'||LTRIM(TO_CHAR(9*dbms_random.value,'0')) class_fld
21:49:36  23  ,      'PROD'||LTRIM(TO_CHAR(9*dbms_random.value,'0')) program_code
21:49:36  24  ,      ' ' budget_ref
21:49:36  25  ,      'AF'||LTRIM(TO_CHAR(999*dbms_random.value,'000')) affiliate
21:49:36  26  ,      'AFI'||LTRIM(TO_CHAR(99999*dbms_random.value,'00000')) affiliate_intra1
21:49:36  27  ,      'AFI'||LTRIM(TO_CHAR( 9999*dbms_random.value,'0000')) affiliate_intra2
21:49:36  28  ,      'CF'||LTRIM(TO_CHAR(  999*SQRT(dbms_random.value),'000')) chartfield1
21:49:36  29  ,      'CF'||LTRIM(TO_CHAR(99999*dbms_random.value,'00000')) chartfield2
21:49:36  30  ,      'CF'||LTRIM(TO_CHAR( 9999*dbms_random.value,'0000')) chartfield3
21:49:36  31  ,      'PRJ'||LTRIM(TO_CHAR(9999*dbms_random.value,'0000')) project_id
21:49:36  32  ,      'BK'||LTRIM(TO_CHAR(99*dbms_random.value,'00')) book_code
21:49:36  33  ,      'GL'||LTRIM(TO_CHAR(99*dbms_random.value,'00')) gl_adjust_type
21:49:36  34  ,      'GBP' currency_cd
21:49:36  35  ,      ' ' statistics_code
21:49:36  36  ,      fy.fiscal_year
21:49:36  37  ,      ap.accounting_period
21:49:36  38  ,      dbms_random.value(0,1e6) posted_total_amt
21:49:36  39  ,      0 posted_base_amt
21:49:36  40  ,      0 posted_tran_amt
21:49:36  41  ,      'GBP' base_currency
21:49:36  42  ,      SYSDATE dttm_stamp_sec
21:49:36  43  ,      0 process_instance
21:49:36  44  FROM   fy,ap, l, n
21:49:36  45  WHERE  l.ledger = 'BUDGET' or (fy.fiscal_year < 2020 or (fy.fiscal_year = 2020 AND ap.accounting_period <= 6))
21:49:36  46  /

2937915 rows created.

Elapsed: 00:08:21.06
21:57:57 SQL> commit;

Commit complete.

Elapsed: 00:00:00.04
21:57:57 SQL> exec dbms_stats.gather_table_stats('SCOTT','PS_LEDGER');

PL/SQL procedure successfully completed.

Elapsed: 00:00:41.30
21:58:38 SQL> 
21:58:38 SQL> CREATE UNIQUE INDEX ps_ledger ON ps_ledger
21:58:38   2  (business_unit,ledger,account,altacct,deptid
21:58:38   3  ,operating_unit,product,fund_code,class_fld,program_code
21:58:38   4  ,budget_ref,affiliate,affiliate_intra1,affiliate_intra2,chartfield1
21:58:38   5  ,chartfield2,chartfield3,project_id,book_code,gl_adjust_type
21:58:38   6  ,date_code,currency_cd,statistics_code,fiscal_year,accounting_period
21:58:38   7  ) COMPRESS 2 NOPARALLEL
21:58:38   8  /
,date_code,currency_cd,statistics_code,fiscal_year,accounting_period
 *
ERROR at line 6:
ORA-00904: "DATE_CODE": invalid identifier


Elapsed: 00:00:00.00
21:58:38 SQL> 
21:58:38 SQL> CREATE INDEX psxledger ON ps_ledger
21:58:38   2  (ledger, fiscal_year, accounting_period, business_unit, account, chartfield1
21:58:38   3  ) LOCAL COMPRESS 4 PARALLEL
21:58:38   4  /

Index created.

Elapsed: 00:00:13.08
21:58:51 SQL> 
21:58:51 SQL> CREATE INDEX psyledger ON ps_ledger
21:58:51   2  (ledger, fiscal_year, business_unit, account, chartfield1, accounting_period
21:58:51   3  ) LOCAL COMPRESS 3 PARALLEL
21:58:51   4  /

Index created.

Elapsed: 00:00:09.98
21:59:01 SQL> 
21:59:01 SQL> ALTER INDEX ps_ledger NOPARALLEL;
ALTER INDEX ps_ledger NOPARALLEL
*
ERROR at line 1:
ORA-01418: specified index does not exist


Elapsed: 00:00:00.00
21:59:01 SQL> ALTER INDEX psxledger NOPARALLEL;

Index altered.

Elapsed: 00:00:00.01
21:59:01 SQL> ALTER INDEX psyledger NOPARALLEL;

Index altered.

Elapsed: 00:00:00.02
21:59:01 SQL> 
21:59:01 SQL> break on report on ledger skip 1
21:59:01 SQL> compute sum of count(*) on report
21:59:01 SQL> set autotrace off
21:59:01 SQL> select ledger, fiscal_year, count(*), max(accounting_period)
21:59:01   2  from ps_ledger
21:59:01   3  group by ledger, fiscal_year
21:59:01   4  order by 1,2
21:59:01   5  /

LEDGER     FISCAL_YEAR   COUNT(*) MAX(ACCOUNTING_PERIOD)
---------- ----------- ---------- ----------------------
ACTUALS           2018    1000000                    999
                  2019    1000000                    999
                  2020     537915                      6

BUDGET            2018     100000                    999
                  2019     100000                    999
                  2020     100000                    999
                  2021     100000                    999

**********             ----------
sum                       2937915

7 rows selected.

Elapsed: 00:00:03.83
21:59:05 SQL> compute sum of count(*) on fiscal_year
21:59:05 SQL> break on report on fiscal_year skip 1 on ledger skip 1
21:59:05 SQL> select ledger, fiscal_year, accounting_period, count(*)
21:59:05   2  from ps_ledger
21:59:05   3  group by ledger, fiscal_year, accounting_period
21:59:05   4  order by 1,2,3
21:59:05   5  /

LEDGER     FISCAL_YEAR ACCOUNTING_PERIOD   COUNT(*)
---------- ----------- ----------------- ----------
ACTUALS           2018                 0      76943
                                       1      76606
                                       2      76630
                                       3      76358
                                       4      77097
                                       5      76806
                                       6      76678
                                       7      76220
                                       8      77112
                                       9      76643
                                      10      76813
                                      11      77180
                                      12      76914
                                     998       1000
                                     999       1000

********** ***********                   ----------
           sum                              1000000

ACTUALS           2019                 0      76774
                                       1      76462
                                       2      76963
                                       3      77273
                                       4      76700
                                       5      77217
                                       6      76229
                                       7      76629
                                       8      76782
                                       9      76602
                                      10      76729
                                      11      76970
                                      12      76670
                                     998       1000
                                     999       1000

********** ***********                   ----------
           sum                              1000000

ACTUALS           2020                 0      76462
                                       1      76669
                                       2      77470
                                       3      76614
                                       4      76703
                                       5      77267
                                       6      76730

********** ***********                   ----------
           sum                               537915

BUDGET            2018                 0       7674
                                       1       7743
                                       2       7709
                                       3       7592
                                       4       7771
                                       5       7691
                                       6       7534
                                       7       7679
                                       8       7556
                                       9       7630
                                      10       7685
                                      11       7768
                                      12       7768
                                     998        100
                                     999        100

********** ***********                   ----------
           sum                               100000

BUDGET            2019                 0       7674
                                       1       7762
                                       2       7635
                                       3       7664
                                       4       7641
                                       5       7618
                                       6       7541
                                       7       7762
                                       8       7692
                                       9       7689
                                      10       7587
                                      11       7860
                                      12       7675
                                     998        100
                                     999        100

********** ***********                   ----------
           sum                               100000

BUDGET            2020                 0       7657
                                       1       7672
                                       2       7773
                                       3       7767
                                       4       7649
                                       5       7652
                                       6       7628
                                       7       7715
                                       8       7722

LEDGER     FISCAL_YEAR ACCOUNTING_PERIOD   COUNT(*)
---------- ----------- ----------------- ----------
BUDGET            2020                 9       7654
                                      10       7675
                                      11       7696
                                      12       7540
                                     998        100
                                     999        100

********** ***********                   ----------
           sum                               100000

BUDGET            2021                 0       7521
                                       1       7707
                                       2       7659
                                       3       7616
                                       4       7694
                                       5       7796
                                       6       7722
                                       7       7558
                                       8       7778
                                       9       7694
                                      10       7724
                                      11       7672
                                      12       7659
                                     998        100
                                     999        100

********** ***********                   ----------
           sum                               100000

                                         ----------
sum                                         2937915

97 rows selected.

Elapsed: 00:00:03.28
21:59:08 SQL> break on ledger skip 1 on fiscal_year skip 1
21:59:08 SQL> select ledger, account, count(*)
21:59:08   2  from ps_ledger
21:59:08   3  where 1=2
21:59:08   4  group by ledger, account
21:59:08   5  order by 1,3
21:59:08   6  /

no rows selected

Elapsed: 00:00:00.01
21:59:08 SQL> 
21:59:08 SQL> TRUNCATE TABLE PSTREESELECT05;

Table truncated.

Elapsed: 00:00:00.02
21:59:08 SQL> TRUNCATE TABLE PSTREESELECT10;

Table truncated.

Elapsed: 00:00:00.02
21:59:08 SQL> 
21:59:08 SQL> INSERT INTO PSTREESELECT05
21:59:08   2  WITH x as (SELECT DISTINCT business_unit FROM ps_ledger)
21:59:08   3  , y as (SELECT 30982, FLOOR(DBMS_RANDOM.value(1,1e10)) tree_node_num, business_unit FROM x)
21:59:08   4  select y.*, business_unit FROM y
21:59:08   5  /

2 rows created.

Elapsed: 00:00:02.34
21:59:11 SQL> INSERT INTO PSTREESELECT10
21:59:11   2  WITH x as (SELECT DISTINCT account FROM ps_ledger)
21:59:11   3  , y as (SELECT 30984, FLOOR(DBMS_RANDOM.value(1,1e10)) tree_node_num, account FROM x)
21:59:11   4  select y.*, account FROM y
21:59:11   5  where mod(tree_node_num,100)<25
21:59:11   6  /

228 rows created.

Elapsed: 00:00:03.38
21:59:14 SQL> INSERT INTO PSTREESELECT10
21:59:14   2  WITH x as (SELECT DISTINCT chartfield1 FROM ps_ledger)
21:59:14   3  , y as (SELECT 30985, FLOOR(DBMS_RANDOM.value(1,1e10)) tree_node_num, chartfield1 FROM x)
21:59:14   4  select y.*, chartfield1 FROM y
21:59:14   5  where mod(tree_node_num,100)<10
21:59:14   6  /

90 rows created.

Elapsed: 00:00:03.46
21:59:18 SQL> commit;

Commit complete.

Elapsed: 00:00:00.01
21:59:18 SQL> 
21:59:18 SQL> exec dbms_stats.gather_table_stats('SCOTT','PSTREESELECT05');

PL/SQL procedure successfully completed.

Elapsed: 00:00:00.20
21:59:18 SQL> exec dbms_stats.gather_table_stats('SCOTT','PSTREESELECT10');

PL/SQL procedure successfully completed.

Elapsed: 00:00:00.55
21:59:18 SQL> 
21:59:18 SQL> ALTER TABLE PS_LEDGER NOPARALLEL;

Table altered.

Elapsed: 00:00:00.01
21:59:18 SQL> 
21:59:18 SQL> /*explain plan for
21:59:18 SQL> SELECT L.TREE_NODE_NUM,L2.TREE_NODE_NUM,SUM(A.POSTED_TOTAL_AMT)
21:59:18 SQL> FROM   PS_LEDGER A
21:59:18 SQL> ,      PSTREESELECT05 L1
21:59:18 SQL> ,      PSTREESELECT10 L
21:59:18 SQL> ,      PSTREESELECT10 L2
21:59:18 SQL> WHERE  A.LEDGER='ACTUALS'
21:59:18 SQL> AND    A.FISCAL_YEAR=2020
21:59:18 SQL> AND    A.ACCOUNTING_PERIOD BETWEEN 1 AND 2
21:59:18 SQL> AND    L1.SELECTOR_NUM=30982 AND A.BUSINESS_UNIT=L1.RANGE_FROM_05
21:59:18 SQL> AND    L.SELECTOR_NUM=30985 AND A.CHARTFIELD1=L.RANGE_FROM_10
21:59:18 SQL> AND    L2.SELECTOR_NUM=30984 AND A.ACCOUNT=L2.RANGE_FROM_10
21:59:18 SQL> AND    A.CURRENCY_CD='GBP'
21:59:18 SQL> GROUP BY L.TREE_NODE_NUM,L2.TREE_NODE_NUM
21:59:18 SQL> /
21:59:18 SQL> @@xp*/
21:59:18 SQL> 
21:59:18 SQL> /*CREATE MATERIALIZED VIEW mv_ledger_2019
21:59:18 SQL> PARTITION BY RANGE (FISCAL_YEAR)
21:59:18 SQL> (PARTITION ledger_2019 VALUES LESS THAN (2020)
21:59:18 SQL> ,PARTITION ledger_2020 VALUES LESS THAN (2021)
21:59:18 SQL> ) PCTFREE 0 COMPRESS
21:59:18 SQL> REFRESH COMPLETE ON DEMAND
21:59:18 SQL> ENABLE QUERY REWRITE AS
21:59:18 SQL> SELECT business_unit, account, chartfield1, fiscal_year, accounting_period,
21:59:18 SQL> sum(posted_total_amt) posted_total_amt
21:59:18 SQL> FROM ps_ledger
21:59:18 SQL> WHERE fiscal_year = 2019
21:59:18 SQL> AND   ledger = 'ACTUALS'
21:59:18 SQL> AND   currency_cd = 'GBP'
21:59:18 SQL> GROUP BY business_unit, account, chartfield1, fiscal_year, accounting_period
21:59:18 SQL> */
21:59:18 SQL> 
21:59:18 SQL> CREATE MATERIALIZED VIEW mv_ledger_2020
21:59:18   2  PARTITION BY RANGE (FISCAL_YEAR)
21:59:18   3  (PARTITION ledger_2019 VALUES LESS THAN (2020)
21:59:18   4  ,PARTITION ledger_2020 VALUES LESS THAN (2021)
21:59:18   5  ) PCTFREE 0 COMPRESS
21:59:18   6  REFRESH COMPLETE ON DEMAND
21:59:18   7  ENABLE QUERY REWRITE AS
21:59:18   8  SELECT business_unit, account, chartfield1, fiscal_year, accounting_period,
21:59:18   9  sum(posted_total_amt) posted_total_amt
21:59:18  10  FROM ps_ledger
21:59:18  11  WHERE fiscal_year >= 2019
21:59:18  12  AND   ledger = 'ACTUALS'
21:59:18  13  AND   currency_cd = 'GBP'
21:59:18  14  GROUP BY business_unit, account, chartfield1, fiscal_year, accounting_period
21:59:18  15  /

Materialized view created.

Elapsed: 00:00:23.05
21:59:41 SQL> 
21:59:41 SQL> @@mvpop
21:59:41 SQL> REM mvpop.sql
21:59:41 SQL> set autotrace off
21:59:41 SQL> break on table_name skip 1 on partition_name
21:59:41 SQL> column table_name format a20
21:59:41 SQL> column mview_name format a20
21:59:41 SQL> SELECT MVIEW_NAME, STALENESS, LAST_REFRESH_TYPE, COMPILE_STATE FROM USER_MVIEWS ORDER BY MVIEW_NAME;

MVIEW_NAME           STALENESS           LAST_REF COMPILE_STATE
-------------------- ------------------- -------- -------------------
MV_LEDGER_2020       FRESH               COMPLETE VALID

Elapsed: 00:00:00.00
21:59:41 SQL> 
21:59:41 SQL> --exec dbms_mview.refresh(list=>'MV_LEDGER_2019',method=>'P',atomic_refresh=>FALSE);
21:59:41 SQL> --exec dbms_mview.refresh(list=>'MV_LEDGER_2020',method=>'P',atomic_refresh=>FALSE);
21:59:41 SQL> 
21:59:41 SQL> --exec dbms_mview.refresh(list=>'MV_LEDGER_2019',method=>'C',atomic_refresh=>FALSE);
21:59:41 SQL> --exec dbms_mview.refresh(list=>'MV_LEDGER_2020',method=>'C',atomic_refresh=>FALSE);
21:59:41 SQL> 
21:59:41 SQL> ALTER MATERIALIZED VIEW mv_ledger_2019 NOPARALLEL;
ALTER MATERIALIZED VIEW mv_ledger_2019 NOPARALLEL
*
ERROR at line 1:
ORA-12003: materialized view or zonemap "SCOTT"."MV_LEDGER_2019" does not exist


Elapsed: 00:00:00.01
21:59:41 SQL> exec dbms_stats.set_table_prefs('SCOTT','MV_LEDGER_2019','METHOD_OPT','FOR ALL COLUMNS SIZE 1, FOR COLUMNS FISCAL_YEAR, ACCOUNTING_PERIOD, BUSINESS_UNIT SIZE 254');
BEGIN dbms_stats.set_table_prefs('SCOTT','MV_LEDGER_2019','METHOD_OPT','FOR ALL COLUMNS SIZE 1, FOR COLUMNS FISCAL_YEAR, ACCOUNTING_PERIOD, BUSINESS_UNIT SIZE 254'); END;

*
ERROR at line 1:
ORA-20000: TABLE "SCOTT"."MV_LEDGER_2019" does not exist or insufficient privileges
ORA-06512: at "SYS.DBMS_STATS", line 52981
ORA-06512: at "SYS.DBMS_STATS", line 9446
ORA-06512: at "SYS.DBMS_STATS", line 52904
ORA-06512: at line 1


Elapsed: 00:00:00.01
21:59:41 SQL> exec dbms_stats.set_table_prefs('SCOTT','MV_LEDGER_2019','GRANULARITY','ALL');
BEGIN dbms_stats.set_table_prefs('SCOTT','MV_LEDGER_2019','GRANULARITY','ALL'); END;

*
ERROR at line 1:
ORA-20000: TABLE "SCOTT"."MV_LEDGER_2019" does not exist or insufficient privileges
ORA-06512: at "SYS.DBMS_STATS", line 52981
ORA-06512: at "SYS.DBMS_STATS", line 9446
ORA-06512: at "SYS.DBMS_STATS", line 52904
ORA-06512: at line 1


Elapsed: 00:00:00.01
21:59:41 SQL> 
21:59:41 SQL> ALTER MATERIALIZED VIEW mv_ledger_2020 NOPARALLEL;

Materialized view altered.

Elapsed: 00:00:00.01
21:59:41 SQL> exec dbms_stats.set_table_prefs('SCOTT','MV_LEDGER_2020','METHOD_OPT','FOR ALL COLUMNS SIZE 1, FOR COLUMNS FISCAL_YEAR, ACCOUNTING_PERIOD, BUSINESS_UNIT SIZE 254');

PL/SQL procedure successfully completed.

Elapsed: 00:00:00.02
21:59:42 SQL> exec dbms_stats.set_table_prefs('SCOTT','MV_LEDGER_2020','GRANULARITY','ALL');

PL/SQL procedure successfully completed.

Elapsed: 00:00:00.01
21:59:42 SQL> 
21:59:42 SQL> --exec dbms_stats.gather_table_stats('SCOTT','MV_LEDGER_2019');
21:59:42 SQL> --exec dbms_stats.gather_table_stats('SCOTT','MV_LEDGER_2020');
21:59:42 SQL> @@mvvol
21:59:42 SQL> REM mvvol.sql
21:59:42 SQL> 
21:59:42 SQL> set autotrace off
21:59:42 SQL> break on table_name skip 1 on partition_name
21:59:42 SQL> column table_name format a15
21:59:42 SQL> column column_name format a20
21:59:42 SQL> column mview_name format a20
21:59:42 SQL> column partition_position format 999 heading 'Part|Pos'
21:59:42 SQL> column subpartition_position format 999 heading 'Sub-|Part|Pos'
21:59:42 SQL> column partition_name format a20
21:59:42 SQL> column subpartition_name format a25
21:59:42 SQL> column num_rows format 9999999
21:59:42 SQL> column num_distinct heading 'Num|Distinct' format 9999999
21:59:42 SQL> column num_buckets heading 'Num|Buckets'	format 9999
21:59:42 SQL> column blocks format 99999
21:59:42 SQL> column rpb format 999.9 heading 'Rows|per|Block'
21:59:42 SQL> SELECT MVIEW_NAME, STALENESS, LAST_REFRESH_TYPE, COMPILE_STATE FROM USER_MVIEWS ORDER BY MVIEW_NAME;

MVIEW_NAME           STALENESS           LAST_REF COMPILE_STATE
-------------------- ------------------- -------- -------------------
MV_LEDGER_2020       FRESH               COMPLETE VALID

Elapsed: 00:00:00.00
21:59:42 SQL> 
21:59:42 SQL> select count(*) from mv_ledger_2019;
select count(*) from mv_ledger_2019
                     *
ERROR at line 1:
ORA-00942: table or view does not exist


Elapsed: 00:00:00.00
21:59:42 SQL> select count(*) from mv_ledger_2020;

  COUNT(*)
----------
   1456077

Elapsed: 00:00:00.09
21:59:42 SQL> 
21:59:42 SQL> select a.table_name, a.partition_position, a.partition_name, a.subpartition_position, a.subpartition_name
21:59:42   2  , a.num_rows, a.blocks, a.num_rows/nullif(a.blocks,0) rpb
21:59:42   3  , COALESCE(c.compression, b.compression) compression
21:59:42   4  , COALESCE(c.compress_for, b.compress_for) compress_for
21:59:42   5  from user_tab_statistics a
21:59:42   6  	LEFT OUTER JOIN user_tab_partitions b
21:59:42   7  	  ON a.table_name = b.table_name
21:59:42   8  	  AND a.partition_name = b.partition_name
21:59:42   9  	LEFT OUTER JOIN user_tab_subpartitions c
21:59:42  10  	  ON a.table_name = c.table_name
21:59:42  11  	  AND a.partition_name = c.partition_name
21:59:42  12  	  AND a.subpartition_name = c.subpartition_name
21:59:42  13  where a.table_name like '%LEDGER%'
21:59:42  14  order by a.table_name, a.partition_position, a.subpartition_position nulls first
21:59:42  15  /

                                          Sub-                                             Rows
                Part                      Part                                              per
TABLE_NAME       Pos PARTITION_NAME        Pos SUBPARTITION_NAME         NUM_ROWS BLOCKS  Block COMPRESS COMPRESS_FOR
--------------- ---- -------------------- ---- ------------------------- -------- ------ ------ -------- ------------------------------
MV_LEDGER_2020     1 LEDGER_2019                                                                ENABLED  BASIC
                   2 LEDGER_2020                                                                ENABLED  BASIC
                                                                          1456077   4864  299.4

PS_LEDGER          1 LEDGER_2018                                          1100000  17893   61.5 ENABLED  BASIC
                   2 LEDGER_2019                                          1100000  17892   61.5 ENABLED  BASIC
                   3 LEDGER_2020                                           637915  16456   38.8 DISABLED
                   4 LEDGER_2021                                           100000   2559   39.1 DISABLED
                                                                          2937915  54800   53.6


8 rows selected.

Elapsed: 00:00:00.02
21:59:42 SQL> 
21:59:42 SQL> column extension format a40
21:59:42 SQL> select s.table_name, s.column_name, s.num_distinct, s.num_buckets, s.histogram, s.last_analyzed, e.extension
21:59:42   2  from user_tab_col_statistics s
21:59:42   3  	LEFT OUTER JOIN user_stat_extensions e
21:59:42   4  	ON e.table_name = s.table_name
21:59:42   5  	AND e.extension_name = s.column_name
21:59:42   6  where s.table_name like 'MV_LEDGER%'
21:59:42   7  order by 1,2
21:59:42   8  ;

                                          Num     Num
TABLE_NAME      COLUMN_NAME          Distinct Buckets HISTOGRAM       LAST_ANALYZED       EXTENSION
--------------- -------------------- -------- ------- --------------- ------------------- ----------------------------------------
MV_LEDGER_2020  ACCOUNT                   999       1 NONE            21:59:33 15/11/2020
                ACCOUNTING_PERIOD          15       1 NONE            21:59:33 15/11/2020
                BUSINESS_UNIT               2       1 NONE            21:59:33 15/11/2020
                CHARTFIELD1               999       1 NONE            21:59:33 15/11/2020
                FISCAL_YEAR                 2       1 NONE            21:59:33 15/11/2020
                POSTED_TOTAL_AMT      1456077       1 NONE            21:59:33 15/11/2020


6 rows selected.

Elapsed: 00:00:00.02
21:59:42 SQL> column extension format a40
21:59:42 SQL> select s.table_name, s.partition_name, s.column_name, s.num_distinct, s.num_buckets, s.histogram, s.last_analyzed, e.extension
21:59:42   2  from user_part_col_statistics s
21:59:42   3  	LEFT OUTER JOIN user_stat_extensions e
21:59:42   4  	ON e.table_name = s.table_name
21:59:42   5  	AND e.extension_name = s.column_name
21:59:42   6  where s.table_name like 'MV_LEDGER%'
21:59:42   7  order by 1,2
21:59:42   8  ;

                                                               Num     Num
TABLE_NAME      PARTITION_NAME       COLUMN_NAME          Distinct Buckets HISTOGRAM       LAST_ANALYZED       EXTENSION
--------------- -------------------- -------------------- -------- ------- --------------- ------------------- ----------------------------------------
MV_LEDGER_2020  LEDGER_2019          BUSINESS_UNIT                         NONE
                                     ACCOUNT                               NONE
                                     CHARTFIELD1                           NONE
                                     FISCAL_YEAR                           NONE
                                     ACCOUNTING_PERIOD                     NONE
                                     POSTED_TOTAL_AMT                      NONE
                                     SYS_NC00007$                          NONE                                (SYS_OP_MAP_NONNULL("BUSINESS_UNIT"))
                                     SYS_NC00008$                          NONE                                (SYS_OP_MAP_NONNULL("ACCOUNT"))
                                     SYS_NC00009$                          NONE                                (SYS_OP_MAP_NONNULL("CHARTFIELD1"))
                                     SYS_NC00010$                          NONE                                (SYS_OP_MAP_NONNULL("FISCAL_YEAR"))
                                     SYS_NC00011$                          NONE                                (SYS_OP_MAP_NONNULL("ACCOUNTING_PERIOD")
                                                                                                               )

                LEDGER_2020          BUSINESS_UNIT                         NONE
                                     ACCOUNT                               NONE
                                     CHARTFIELD1                           NONE
                                     FISCAL_YEAR                           NONE
                                     ACCOUNTING_PERIOD                     NONE
                                     POSTED_TOTAL_AMT                      NONE
                                     SYS_NC00007$                          NONE                                (SYS_OP_MAP_NONNULL("BUSINESS_UNIT"))
                                     SYS_NC00008$                          NONE                                (SYS_OP_MAP_NONNULL("ACCOUNT"))
                                     SYS_NC00009$                          NONE                                (SYS_OP_MAP_NONNULL("CHARTFIELD1"))
                                     SYS_NC00010$                          NONE                                (SYS_OP_MAP_NONNULL("FISCAL_YEAR"))
                                     SYS_NC00011$                          NONE                                (SYS_OP_MAP_NONNULL("ACCOUNTING_PERIOD")
                                                                                                               )



22 rows selected.

Elapsed: 00:00:00.02
21:59:42 SQL> 
21:59:42 SQL> column extension format a40
21:59:42 SQL> select s.table_name, s.subpartition_name, s.column_name, s.num_distinct, s.num_buckets, s.histogram, s.last_analyzed, e.extension
21:59:42   2  from user_subpart_col_statistics s
21:59:42   3  	LEFT OUTER JOIN user_stat_extensions e
21:59:42   4  	ON e.table_name = s.table_name
21:59:42   5  	AND e.extension_name = s.column_name
21:59:42   6  where s.table_name like 'MV_LEDGER%'
21:59:42   7  order by 1,2
21:59:42   8  ;

no rows selected

Elapsed: 00:00:00.00
21:59:42 SQL> @@mvsql
21:59:42 SQL> REM mvsql.sql
21:59:42 SQL> set autotrace off
21:59:42 SQL> 
21:59:42 SQL> REM 2018
21:59:42 SQL> set lines 200 pages 999
21:59:42 SQL> explain plan for
21:59:42   2  SELECT L.TREE_NODE_NUM,L2.TREE_NODE_NUM,SUM(A.POSTED_TOTAL_AMT)
21:59:42   3  FROM   PS_LEDGER A
21:59:42   4  ,      PSTREESELECT05 L1
21:59:42   5  ,      PSTREESELECT10 L
21:59:42   6  ,      PSTREESELECT10 L2
21:59:42   7  WHERE  A.LEDGER='ACTUALS'
21:59:42   8  AND    A.FISCAL_YEAR=2018
21:59:42   9  AND    A.ACCOUNTING_PERIOD BETWEEN 1 AND 6
21:59:42  10  AND    L1.SELECTOR_NUM=30982 AND A.BUSINESS_UNIT=L1.RANGE_FROM_05
21:59:42  11  AND    L.SELECTOR_NUM=30985 AND A.CHARTFIELD1=L.RANGE_FROM_10
21:59:42  12  AND    L2.SELECTOR_NUM=30984 AND A.ACCOUNT=L2.RANGE_FROM_10
21:59:42  13  AND    A.CURRENCY_CD='GBP'
21:59:42  14  GROUP BY L.TREE_NODE_NUM,L2.TREE_NODE_NUM
21:59:42  15  /

Explained.

Elapsed: 00:00:00.15
21:59:42 SQL> @@xp
21:59:42 SQL> REM xp.sql
21:59:42 SQL> REM spool xp
21:59:42 SQL> REM set pages 9999 lines 200 autotrace off
21:59:42 SQL> select * from table(dbms_xplan.display(null,null,'ADVANCED -PROJECTION +ADAPTIVE'));

PLAN_TABLE_OUTPUT
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Plan hash value: 1780139226

---------------------------------------------------------------------------------------------------------------
| Id  | Operation                 | Name              | Rows  | Bytes | Cost (%CPU)| Time     | Pstart| Pstop |
---------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT          |                   |   822 | 76446 |  4883   (1)| 00:00:01 |       |       |
|   1 |  HASH GROUP BY            |                   |   822 | 76446 |  4883   (1)| 00:00:01 |       |       |
|*  2 |   HASH JOIN               |                   |   822 | 76446 |  4882   (1)| 00:00:01 |       |       |
|*  3 |    INDEX RANGE SCAN       | PS_PSTREESELECT10 |   228 |  4332 |     2   (0)| 00:00:01 |       |       |
|*  4 |    HASH JOIN              |                   |  3601 |   260K|  4880   (1)| 00:00:01 |       |       |
|   5 |     MERGE JOIN CARTESIAN  |                   |   180 |  5220 |     3   (0)| 00:00:01 |       |       |
|*  6 |      INDEX RANGE SCAN     | PS_PSTREESELECT05 |     2 |    22 |     1   (0)| 00:00:01 |       |       |
|   7 |      BUFFER SORT          |                   |    90 |  1620 |     2   (0)| 00:00:01 |       |       |
|*  8 |       INDEX RANGE SCAN    | PS_PSTREESELECT10 |    90 |  1620 |     1   (0)| 00:00:01 |       |       |
|   9 |     PARTITION RANGE SINGLE|                   | 39970 |  1756K|  4877   (1)| 00:00:01 |     1 |     1 |
|* 10 |      TABLE ACCESS FULL    | PS_LEDGER         | 39970 |  1756K|  4877   (1)| 00:00:01 |     1 |     1 |
---------------------------------------------------------------------------------------------------------------

Query Block Name / Object Alias (identified by operation id):
-------------------------------------------------------------

   1 - SEL$1
   3 - SEL$1 / L2@SEL$1
   6 - SEL$1 / L1@SEL$1
   8 - SEL$1 / L@SEL$1
  10 - SEL$1 / A@SEL$1

Outline Data
-------------

  /*+
      BEGIN_OUTLINE_DATA
      USE_HASH_AGGREGATION(@"SEL$1")
      SWAP_JOIN_INPUTS(@"SEL$1" "L2"@"SEL$1")
      USE_HASH(@"SEL$1" "L2"@"SEL$1")
      USE_HASH(@"SEL$1" "A"@"SEL$1")
      USE_MERGE_CARTESIAN(@"SEL$1" "L"@"SEL$1")
      LEADING(@"SEL$1" "L1"@"SEL$1" "L"@"SEL$1" "A"@"SEL$1" "L2"@"SEL$1")
      INDEX(@"SEL$1" "L2"@"SEL$1" ("PSTREESELECT10"."SELECTOR_NUM" "PSTREESELECT10"."TREE_NODE_NUM"
              "PSTREESELECT10"."RANGE_FROM_10"))
      FULL(@"SEL$1" "A"@"SEL$1")
      INDEX(@"SEL$1" "L"@"SEL$1" ("PSTREESELECT10"."SELECTOR_NUM" "PSTREESELECT10"."TREE_NODE_NUM"
              "PSTREESELECT10"."RANGE_FROM_10"))
      INDEX(@"SEL$1" "L1"@"SEL$1" ("PSTREESELECT05"."SELECTOR_NUM" "PSTREESELECT05"."TREE_NODE_NUM"
              "PSTREESELECT05"."RANGE_FROM_05"))
      OUTLINE_LEAF(@"SEL$1")
      ALL_ROWS
      DB_VERSION('19.1.0')
      OPTIMIZER_FEATURES_ENABLE('19.1.0')
      IGNORE_OPTIM_EMBEDDED_HINTS
      END_OUTLINE_DATA
  */

Predicate Information (identified by operation id):
---------------------------------------------------

   2 - access("A"."ACCOUNT"="L2"."RANGE_FROM_10")
   3 - access("L2"."SELECTOR_NUM"=30984)
   4 - access("A"."BUSINESS_UNIT"="L1"."RANGE_FROM_05" AND "A"."CHARTFIELD1"="L"."RANGE_FROM_10")
   6 - access("L1"."SELECTOR_NUM"=30982)
   8 - access("L"."SELECTOR_NUM"=30985)
  10 - filter("A"."ACCOUNTING_PERIOD"<=6 AND "A"."LEDGER"='ACTUALS' AND "A"."FISCAL_YEAR"=2018 AND
              "A"."ACCOUNTING_PERIOD">=1 AND "A"."CURRENCY_CD"='GBP')

Query Block Registry:
---------------------

  <q o="2" f="y"><n><![CDATA[SEL$1]]></n><f><h><t><![CDATA[A]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![C
        DATA[L]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![CDATA[L1]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![C
        DATA[L2]]></t><s><![CDATA[SEL$1]]></s></h></f></q>


71 rows selected.

Elapsed: 00:00:00.12
21:59:42 SQL> REM spool off
21:59:42 SQL> 
21:59:42 SQL> REM 2019
21:59:42 SQL> explain plan for
21:59:42   2  SELECT L.TREE_NODE_NUM,L2.TREE_NODE_NUM,SUM(A.POSTED_TOTAL_AMT)
21:59:42   3  FROM   PS_LEDGER A
21:59:42   4  ,      PSTREESELECT05 L1
21:59:42   5  ,      PSTREESELECT10 L
21:59:42   6  ,      PSTREESELECT10 L2
21:59:42   7  WHERE  A.LEDGER='ACTUALS'
21:59:42   8  AND    A.FISCAL_YEAR=2019
21:59:42   9  AND    A.ACCOUNTING_PERIOD BETWEEN 1 AND 6
21:59:42  10  AND    L1.SELECTOR_NUM=30982 AND A.BUSINESS_UNIT=L1.RANGE_FROM_05
21:59:42  11  AND    L.SELECTOR_NUM=30985 AND A.CHARTFIELD1=L.RANGE_FROM_10
21:59:42  12  AND    L2.SELECTOR_NUM=30984 AND A.ACCOUNT=L2.RANGE_FROM_10
21:59:42  13  AND    A.CURRENCY_CD='GBP'
21:59:42  14  GROUP BY L.TREE_NODE_NUM,L2.TREE_NODE_NUM
21:59:42  15  /

Explained.

Elapsed: 00:00:00.24
21:59:42 SQL> @@xp
21:59:42 SQL> REM xp.sql
21:59:42 SQL> REM spool xp
21:59:42 SQL> REM set pages 9999 lines 200 autotrace off
21:59:42 SQL> select * from table(dbms_xplan.display(null,null,'ADVANCED -PROJECTION +ADAPTIVE'));

PLAN_TABLE_OUTPUT
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Plan hash value: 4006930814

----------------------------------------------------------------------------------------------------------------------
| Id  | Operation                        | Name              | Rows  | Bytes | Cost (%CPU)| Time     | Pstart| Pstop |
----------------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT                 |                   |  1088 | 88128 |   674   (2)| 00:00:01 |       |       |
|   1 |  HASH GROUP BY                   |                   |  1088 | 88128 |   674   (2)| 00:00:01 |       |       |
|*  2 |   HASH JOIN                      |                   |  1088 | 88128 |   673   (2)| 00:00:01 |       |       |
|*  3 |    INDEX RANGE SCAN              | PS_PSTREESELECT10 |   228 |  4332 |     2   (0)| 00:00:01 |       |       |
|*  4 |    HASH JOIN                     |                   |  4767 |   288K|   671   (2)| 00:00:01 |       |       |
|   5 |     MERGE JOIN CARTESIAN         |                   |   180 |  5220 |     3   (0)| 00:00:01 |       |       |
|*  6 |      INDEX RANGE SCAN            | PS_PSTREESELECT05 |     2 |    22 |     1   (0)| 00:00:01 |       |       |
|   7 |      BUFFER SORT                 |                   |    90 |  1620 |     2   (0)| 00:00:01 |       |       |
|*  8 |       INDEX RANGE SCAN           | PS_PSTREESELECT10 |    90 |  1620 |     1   (0)| 00:00:01 |       |       |
|   9 |     PARTITION RANGE SINGLE       |                   | 52909 |  1705K|   668   (2)| 00:00:01 |     1 |     1 |
|* 10 |      MAT_VIEW REWRITE ACCESS FULL| MV_LEDGER_2020    | 52909 |  1705K|   668   (2)| 00:00:01 |     1 |     1 |
----------------------------------------------------------------------------------------------------------------------

Query Block Name / Object Alias (identified by operation id):
-------------------------------------------------------------

   1 - SEL$1E60250C
   3 - SEL$1E60250C / L2@SEL$1
   6 - SEL$1E60250C / L1@SEL$1
   8 - SEL$1E60250C / L@SEL$1
  10 - SEL$1E60250C / MV_LEDGER_2020@SEL$5272D5B4

Outline Data
-------------

  /*+
      BEGIN_OUTLINE_DATA
      USE_HASH_AGGREGATION(@"SEL$1E60250C")
      SWAP_JOIN_INPUTS(@"SEL$1E60250C" "L2"@"SEL$1")
      USE_HASH(@"SEL$1E60250C" "L2"@"SEL$1")
      USE_HASH(@"SEL$1E60250C" "MV_LEDGER_2020"@"SEL$5272D5B4")
      USE_MERGE_CARTESIAN(@"SEL$1E60250C" "L"@"SEL$1")
      LEADING(@"SEL$1E60250C" "L1"@"SEL$1" "L"@"SEL$1" "MV_LEDGER_2020"@"SEL$5272D5B4" "L2"@"SEL$1")
      INDEX(@"SEL$1E60250C" "L2"@"SEL$1" ("PSTREESELECT10"."SELECTOR_NUM" "PSTREESELECT10"."TREE_NODE_NUM"
              "PSTREESELECT10"."RANGE_FROM_10"))
      FULL(@"SEL$1E60250C" "MV_LEDGER_2020"@"SEL$5272D5B4")
      INDEX(@"SEL$1E60250C" "L"@"SEL$1" ("PSTREESELECT10"."SELECTOR_NUM" "PSTREESELECT10"."TREE_NODE_NUM"
              "PSTREESELECT10"."RANGE_FROM_10"))
      INDEX(@"SEL$1E60250C" "L1"@"SEL$1" ("PSTREESELECT05"."SELECTOR_NUM" "PSTREESELECT05"."TREE_NODE_NUM"
              "PSTREESELECT05"."RANGE_FROM_05"))
      OUTLINE(@"SEL$1")
      REWRITE(@"SEL$1" "MV_LEDGER_2020")
      OUTLINE(@"SEL$68C95E58")
      REWRITE(@"SEL$68C95E58" "MV_LEDGER_2020")
      OUTLINE_LEAF(@"SEL$1E60250C")
      ALL_ROWS
      DB_VERSION('19.1.0')
      OPTIMIZER_FEATURES_ENABLE('19.1.0')
      IGNORE_OPTIM_EMBEDDED_HINTS
      END_OUTLINE_DATA
  */

Predicate Information (identified by operation id):
---------------------------------------------------

   2 - access("MV_LEDGER_2020"."ACCOUNT"="L2"."RANGE_FROM_10")
   3 - access("L2"."SELECTOR_NUM"=30984)
   4 - access("MV_LEDGER_2020"."BUSINESS_UNIT"="L1"."RANGE_FROM_05" AND
              "MV_LEDGER_2020"."CHARTFIELD1"="L"."RANGE_FROM_10")
   6 - access("L1"."SELECTOR_NUM"=30982)
   8 - access("L"."SELECTOR_NUM"=30985)
  10 - filter("MV_LEDGER_2020"."ACCOUNTING_PERIOD"<=6 AND "MV_LEDGER_2020"."FISCAL_YEAR"=2019 AND
              "MV_LEDGER_2020"."ACCOUNTING_PERIOD">=1)

Query Block Registry:
---------------------

  <q o="6" f="y" h="y"><n><![CDATA[SEL$1E60250C]]></n><p><![CDATA[SEL$68C95E58]]></p><i><o><t>MV</t><v><![CDATA[
        MV_LEDGER_2020]]></v></o></i><f><h><t><![CDATA[L]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![CDATA[L1]]></t><s>
        <![CDATA[SEL$1]]></s></h><h><t><![CDATA[L2]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![CDATA[MV_LEDGER_2020]]><
        /t><s><![CDATA[SEL$5272D5B4]]></s></h></f></q>
  <q o="2"><n><![CDATA[SEL$1]]></n><f><h><t><![CDATA[A]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![CDATA[L]]></t>
        <s><![CDATA[SEL$1]]></s></h><h><t><![CDATA[L1]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![CDATA[L2]]></t><s><![
        CDATA[SEL$1]]></s></h></f></q>
  <q o="6" h="y"><n><![CDATA[SEL$68C95E58]]></n><p><![CDATA[SEL$1]]></p><i><o><t>MV</t><v><![CDATA[MV_LEDGER_202
        0]]></v></o></i><f><h><t><![CDATA[L]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![CDATA[L1]]></t><s><![CDATA[SEL$
        1]]></s></h><h><t><![CDATA[L2]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![CDATA[MV_LEDGER_2020]]></t><s><![CDAT
        A[SEL$5272D5B4]]></s></h></f></q>


84 rows selected.

Elapsed: 00:00:00.13
21:59:42 SQL> REM spool off
21:59:42 SQL> 
21:59:42 SQL> REM 2020
21:59:42 SQL> explain plan for
21:59:42   2  SELECT L.TREE_NODE_NUM,L2.TREE_NODE_NUM,SUM(A.POSTED_TOTAL_AMT)
21:59:42   3  FROM   PS_LEDGER A
21:59:42   4  ,      PSTREESELECT05 L1
21:59:42   5  ,      PSTREESELECT10 L
21:59:42   6  ,      PSTREESELECT10 L2
21:59:42   7  WHERE  A.LEDGER='ACTUALS'
21:59:42   8  AND    A.FISCAL_YEAR=2020
21:59:42   9  AND    (A.ACCOUNTING_PERIOD BETWEEN 1 AND 6)
21:59:42  10  AND    L1.SELECTOR_NUM=30982 AND A.BUSINESS_UNIT=L1.RANGE_FROM_05
21:59:42  11  AND    L.SELECTOR_NUM=30985 AND A.CHARTFIELD1=L.RANGE_FROM_10
21:59:42  12  AND    L2.SELECTOR_NUM=30984 AND A.ACCOUNT=L2.RANGE_FROM_10
21:59:42  13  AND    A.CURRENCY_CD='GBP'
21:59:42  14  GROUP BY L.TREE_NODE_NUM,L2.TREE_NODE_NUM
21:59:42  15  /

Explained.

Elapsed: 00:00:00.23
21:59:43 SQL> @@xp
21:59:43 SQL> REM xp.sql
21:59:43 SQL> REM spool xp
21:59:43 SQL> REM set pages 9999 lines 200 autotrace off
21:59:43 SQL> select * from table(dbms_xplan.display(null,null,'ADVANCED -PROJECTION +ADAPTIVE'));

PLAN_TABLE_OUTPUT
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Plan hash value: 4006930814

----------------------------------------------------------------------------------------------------------------------
| Id  | Operation                        | Name              | Rows  | Bytes | Cost (%CPU)| Time     | Pstart| Pstop |
----------------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT                 |                   |  1088 | 88128 |   674   (2)| 00:00:01 |       |       |
|   1 |  HASH GROUP BY                   |                   |  1088 | 88128 |   674   (2)| 00:00:01 |       |       |
|*  2 |   HASH JOIN                      |                   |  1088 | 88128 |   673   (2)| 00:00:01 |       |       |
|*  3 |    INDEX RANGE SCAN              | PS_PSTREESELECT10 |   228 |  4332 |     2   (0)| 00:00:01 |       |       |
|*  4 |    HASH JOIN                     |                   |  4767 |   288K|   671   (2)| 00:00:01 |       |       |
|   5 |     MERGE JOIN CARTESIAN         |                   |   180 |  5220 |     3   (0)| 00:00:01 |       |       |
|*  6 |      INDEX RANGE SCAN            | PS_PSTREESELECT05 |     2 |    22 |     1   (0)| 00:00:01 |       |       |
|   7 |      BUFFER SORT                 |                   |    90 |  1620 |     2   (0)| 00:00:01 |       |       |
|*  8 |       INDEX RANGE SCAN           | PS_PSTREESELECT10 |    90 |  1620 |     1   (0)| 00:00:01 |       |       |
|   9 |     PARTITION RANGE SINGLE       |                   | 52909 |  1705K|   668   (2)| 00:00:01 |     2 |     2 |
|* 10 |      MAT_VIEW REWRITE ACCESS FULL| MV_LEDGER_2020    | 52909 |  1705K|   668   (2)| 00:00:01 |     2 |     2 |
----------------------------------------------------------------------------------------------------------------------

Query Block Name / Object Alias (identified by operation id):
-------------------------------------------------------------

   1 - SEL$1E60250C
   3 - SEL$1E60250C / L2@SEL$1
   6 - SEL$1E60250C / L1@SEL$1
   8 - SEL$1E60250C / L@SEL$1
  10 - SEL$1E60250C / MV_LEDGER_2020@SEL$5272D5B4

Outline Data
-------------

  /*+
      BEGIN_OUTLINE_DATA
      USE_HASH_AGGREGATION(@"SEL$1E60250C")
      SWAP_JOIN_INPUTS(@"SEL$1E60250C" "L2"@"SEL$1")
      USE_HASH(@"SEL$1E60250C" "L2"@"SEL$1")
      USE_HASH(@"SEL$1E60250C" "MV_LEDGER_2020"@"SEL$5272D5B4")
      USE_MERGE_CARTESIAN(@"SEL$1E60250C" "L"@"SEL$1")
      LEADING(@"SEL$1E60250C" "L1"@"SEL$1" "L"@"SEL$1" "MV_LEDGER_2020"@"SEL$5272D5B4" "L2"@"SEL$1")
      INDEX(@"SEL$1E60250C" "L2"@"SEL$1" ("PSTREESELECT10"."SELECTOR_NUM" "PSTREESELECT10"."TREE_NODE_NUM"
              "PSTREESELECT10"."RANGE_FROM_10"))
      FULL(@"SEL$1E60250C" "MV_LEDGER_2020"@"SEL$5272D5B4")
      INDEX(@"SEL$1E60250C" "L"@"SEL$1" ("PSTREESELECT10"."SELECTOR_NUM" "PSTREESELECT10"."TREE_NODE_NUM"
              "PSTREESELECT10"."RANGE_FROM_10"))
      INDEX(@"SEL$1E60250C" "L1"@"SEL$1" ("PSTREESELECT05"."SELECTOR_NUM" "PSTREESELECT05"."TREE_NODE_NUM"
              "PSTREESELECT05"."RANGE_FROM_05"))
      OUTLINE(@"SEL$1")
      REWRITE(@"SEL$1" "MV_LEDGER_2020")
      OUTLINE(@"SEL$68C95E58")
      REWRITE(@"SEL$68C95E58" "MV_LEDGER_2020")
      OUTLINE_LEAF(@"SEL$1E60250C")
      ALL_ROWS
      DB_VERSION('19.1.0')
      OPTIMIZER_FEATURES_ENABLE('19.1.0')
      IGNORE_OPTIM_EMBEDDED_HINTS
      END_OUTLINE_DATA
  */

Predicate Information (identified by operation id):
---------------------------------------------------

   2 - access("MV_LEDGER_2020"."ACCOUNT"="L2"."RANGE_FROM_10")
   3 - access("L2"."SELECTOR_NUM"=30984)
   4 - access("MV_LEDGER_2020"."BUSINESS_UNIT"="L1"."RANGE_FROM_05" AND
              "MV_LEDGER_2020"."CHARTFIELD1"="L"."RANGE_FROM_10")
   6 - access("L1"."SELECTOR_NUM"=30982)
   8 - access("L"."SELECTOR_NUM"=30985)
  10 - filter("MV_LEDGER_2020"."ACCOUNTING_PERIOD"<=6 AND "MV_LEDGER_2020"."FISCAL_YEAR"=2020 AND
              "MV_LEDGER_2020"."ACCOUNTING_PERIOD">=1)

Query Block Registry:
---------------------

  <q o="6" f="y" h="y"><n><![CDATA[SEL$1E60250C]]></n><p><![CDATA[SEL$68C95E58]]></p><i><o><t>MV</t><v><![CDATA[
        MV_LEDGER_2020]]></v></o></i><f><h><t><![CDATA[L]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![CDATA[L1]]></t><s>
        <![CDATA[SEL$1]]></s></h><h><t><![CDATA[L2]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![CDATA[MV_LEDGER_2020]]><
        /t><s><![CDATA[SEL$5272D5B4]]></s></h></f></q>
  <q o="2"><n><![CDATA[SEL$1]]></n><f><h><t><![CDATA[A]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![CDATA[L]]></t>
        <s><![CDATA[SEL$1]]></s></h><h><t><![CDATA[L1]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![CDATA[L2]]></t><s><![
        CDATA[SEL$1]]></s></h></f></q>
  <q o="6" h="y"><n><![CDATA[SEL$68C95E58]]></n><p><![CDATA[SEL$1]]></p><i><o><t>MV</t><v><![CDATA[MV_LEDGER_202
        0]]></v></o></i><f><h><t><![CDATA[L]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![CDATA[L1]]></t><s><![CDATA[SEL$
        1]]></s></h><h><t><![CDATA[L2]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![CDATA[MV_LEDGER_2020]]></t><s><![CDAT
        A[SEL$5272D5B4]]></s></h></f></q>


84 rows selected.

Elapsed: 00:00:00.13
21:59:43 SQL> REM spool off
21:59:43 SQL> set autotrace off
21:59:43 SQL> 
21:59:43 SQL> @@pop2020m7
21:59:43 SQL> REM pop2020m7.sql
21:59:43 SQL> set autotrace off
21:59:43 SQL> insert into ps_ledger
21:59:43   2  with n as (
21:59:43   3  SELECT rownum n from dual connect by level <= 1e6/13
21:59:43   4  --), fy as (
21:59:43   5  --SELECT 2017+rownum fiscal_year FROM dual CONNECT BY level <= 4
21:59:43   6  --), ap as (
21:59:43   7  --SELECT FLOOR(dbms_random.value(0,13)) accounting_period FROM dual connect by level <= 998
21:59:43   8  --UNION ALL SELECT 998 FROM DUAL CONNECT BY LEVEL <= 1
21:59:43   9  --UNION ALL SELECT 999 FROM DUAL CONNECT BY LEVEL <= 1
21:59:43  10  --), l as (
21:59:43  11  --SELECT 'ACTUALS' ledger FROM DUAL CONNECT BY LEVEL <= 10
21:59:43  12  --UNION ALL SELECT 'BUDGET' FROM DUAL
21:59:43  13  )
21:59:43  14  select 'BU'||LTRIM(TO_CHAR(CASE WHEN dbms_random.value <= .9 THEN 1 ELSE 2 END,'000')) business_unit
21:59:43  15  ,      'ACTUALS' ledger
21:59:43  16  ,      'ACC'||LTRIM(TO_CHAR(999*SQRT(dbms_random.value),'000')) account
21:59:43  17  ,      'ALTACCT'||LTRIM(TO_CHAR(999*dbms_random.value,'000')) altacct
21:59:43  18  ,      'DEPT'||LTRIM(TO_CHAR(9999*dbms_random.value,'0000')) deptid
21:59:43  19  ,      'OPUNIT'||LTRIM(TO_CHAR(99*dbms_random.value,'00')) operating_unit
21:59:43  20  ,      'P'||LTRIM(TO_CHAR(99999*dbms_random.value,'00000')) product
21:59:43  21  ,      'FUND'||LTRIM(TO_CHAR(9*dbms_random.value,'0')) fund_code
21:59:43  22  ,      'CLAS'||LTRIM(TO_CHAR(9*dbms_random.value,'0')) class_fld
21:59:43  23  ,      'PROD'||LTRIM(TO_CHAR(9*dbms_random.value,'0')) program_code
21:59:43  24  ,      ' ' budget_ref
21:59:43  25  ,      'AF'||LTRIM(TO_CHAR(999*dbms_random.value,'000')) affiliate
21:59:43  26  ,      'AFI'||LTRIM(TO_CHAR(99999*dbms_random.value,'00000')) affiliate_intra1
21:59:43  27  ,      'AFI'||LTRIM(TO_CHAR( 9999*dbms_random.value,'0000')) affiliate_intra2
21:59:43  28  ,      'CF'||LTRIM(TO_CHAR(  999*SQRT(dbms_random.value),'000')) chartfield1
21:59:43  29  ,      'CF'||LTRIM(TO_CHAR(99999*dbms_random.value,'00000')) chartfield2
21:59:43  30  ,      'CF'||LTRIM(TO_CHAR( 9999*dbms_random.value,'0000')) chartfield3
21:59:43  31  ,      'PRJ'||LTRIM(TO_CHAR(9999*dbms_random.value,'0000')) project_id
21:59:43  32  ,      'BK'||LTRIM(TO_CHAR(99*dbms_random.value,'00')) book_code
21:59:43  33  ,      'GL'||LTRIM(TO_CHAR(99*dbms_random.value,'00')) gl_adjust_type
21:59:43  34  ,      'GBP' currency_cd
21:59:43  35  ,      ' ' statistics_code
21:59:43  36  ,      2020 fiscal_year
21:59:43  37  ,      7 accounting_period
21:59:43  38  ,      dbms_random.value(0,1e6) posted_total_amt
21:59:43  39  ,      0 posted_base_amt
21:59:43  40  ,      0 posted_tran_amt
21:59:43  41  ,      'GBP' base_currency
21:59:43  42  ,      SYSDATE dttm_stamp_sec
21:59:43  43  ,      0 process_instance
21:59:43  44  FROM   n
21:59:43  45  --WHERE  l.ledger = 'ACTUALS'
21:59:43  46  --AND    fy.fiscal_year = 2020
21:59:43  47  --AND    ap.accounting_period = 7
21:59:43  48  /

76923 rows created.

Elapsed: 00:00:18.25
22:00:01 SQL> set lines 200 pages 999 autotrace off
22:00:01 SQL> SELECT MVIEW_NAME, STALENESS, LAST_REFRESH_TYPE, COMPILE_STATE FROM USER_MVIEWS ORDER BY MVIEW_NAME;

MVIEW_NAME           STALENESS           LAST_REF COMPILE_STATE
-------------------- ------------------- -------- -------------------
MV_LEDGER_2020       FRESH               COMPLETE VALID

Elapsed: 00:00:00.00
22:00:01 SQL> commit;

Commit complete.

Elapsed: 00:00:00.02
22:00:01 SQL> column owner format a10
22:00:01 SQL> column table_name format a15
22:00:01 SQL> column mview_name format a15
22:00:01 SQL> column detailobj_owner format a10 heading 'Detailobj|Owner'
22:00:01 SQL> column detailobj_name  format a15
22:00:01 SQL> column detailobj_alias format a20
22:00:01 SQL> column detail_partition_name format a20
22:00:01 SQL> column detail_subpartition_name format a20
22:00:01 SQL> column parent_table_partition format a20
22:00:01 SQL> SELECT MVIEW_NAME, STALENESS, LAST_REFRESH_TYPE, COMPILE_STATE FROM USER_MVIEWS ORDER BY MVIEW_NAME;

MVIEW_NAME      STALENESS           LAST_REF COMPILE_STATE
--------------- ------------------- -------- -------------------
MV_LEDGER_2020  NEEDS_COMPILE       COMPLETE NEEDS_COMPILE

Elapsed: 00:00:00.00
22:00:01 SQL> select * from user_mview_detail_relations;

                           Detailobj
OWNER      MVIEW_NAME      Owner      DETAILOBJ_NAME  DETAILOBJ DETAILOBJ_ALIAS      D NUM_FRESH_PCT_PARTITIONS NUM_STALE_PCT_PARTITIONS
---------- --------------- ---------- --------------- --------- -------------------- - ------------------------ ------------------------
SCOTT      MV_LEDGER_2020  SCOTT      PS_LEDGER       TABLE     PS_LEDGER            Y                        3                        1

Elapsed: 00:00:00.00
22:00:01 SQL> select * from user_mview_detail_partition;

                           Detailobj
OWNER      MVIEW_NAME      Owner      DETAILOBJ_NAME  DETAIL_PARTITION_NAM DETAIL_PARTITION_POSITION FRESHNE LAST_REFRESH_TIME
---------- --------------- ---------- --------------- -------------------- ------------------------- ------- -------------------
SCOTT      MV_LEDGER_2020  SCOTT      PS_LEDGER       LEDGER_2018                                  1 FRESH   21:59:41 15/11/2020
SCOTT      MV_LEDGER_2020  SCOTT      PS_LEDGER       LEDGER_2019                                  2 FRESH   21:59:41 15/11/2020
SCOTT      MV_LEDGER_2020  SCOTT      PS_LEDGER       LEDGER_2020                                  3 STALE   21:59:41 15/11/2020
SCOTT      MV_LEDGER_2020  SCOTT      PS_LEDGER       LEDGER_2021                                  4 FRESH   21:59:41 15/11/2020

Elapsed: 00:00:00.01
22:00:01 SQL> select * from user_mview_detail_subpartition where freshness != 'FRESH';

no rows selected

Elapsed: 00:00:00.00
22:00:01 SQL> 
22:00:01 SQL> @@mvsql
22:00:01 SQL> REM mvsql.sql
22:00:01 SQL> set autotrace off
22:00:01 SQL> 
22:00:01 SQL> REM 2018
22:00:01 SQL> set lines 200 pages 999
22:00:01 SQL> explain plan for
22:00:01   2  SELECT L.TREE_NODE_NUM,L2.TREE_NODE_NUM,SUM(A.POSTED_TOTAL_AMT)
22:00:01   3  FROM   PS_LEDGER A
22:00:01   4  ,      PSTREESELECT05 L1
22:00:01   5  ,      PSTREESELECT10 L
22:00:01   6  ,      PSTREESELECT10 L2
22:00:01   7  WHERE  A.LEDGER='ACTUALS'
22:00:01   8  AND    A.FISCAL_YEAR=2018
22:00:01   9  AND    A.ACCOUNTING_PERIOD BETWEEN 1 AND 6
22:00:01  10  AND    L1.SELECTOR_NUM=30982 AND A.BUSINESS_UNIT=L1.RANGE_FROM_05
22:00:01  11  AND    L.SELECTOR_NUM=30985 AND A.CHARTFIELD1=L.RANGE_FROM_10
22:00:01  12  AND    L2.SELECTOR_NUM=30984 AND A.ACCOUNT=L2.RANGE_FROM_10
22:00:01  13  AND    A.CURRENCY_CD='GBP'
22:00:01  14  GROUP BY L.TREE_NODE_NUM,L2.TREE_NODE_NUM
22:00:01  15  /

Explained.

Elapsed: 00:00:00.16
22:00:01 SQL> @@xp
22:00:01 SQL> REM xp.sql
22:00:01 SQL> REM spool xp
22:00:01 SQL> REM set pages 9999 lines 200 autotrace off
22:00:01 SQL> select * from table(dbms_xplan.display(null,null,'ADVANCED -PROJECTION +ADAPTIVE'));

PLAN_TABLE_OUTPUT
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Plan hash value: 1780139226

---------------------------------------------------------------------------------------------------------------
| Id  | Operation                 | Name              | Rows  | Bytes | Cost (%CPU)| Time     | Pstart| Pstop |
---------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT          |                   |   822 | 76446 |  4883   (1)| 00:00:01 |       |       |
|   1 |  HASH GROUP BY            |                   |   822 | 76446 |  4883   (1)| 00:00:01 |       |       |
|*  2 |   HASH JOIN               |                   |   822 | 76446 |  4882   (1)| 00:00:01 |       |       |
|*  3 |    INDEX RANGE SCAN       | PS_PSTREESELECT10 |   228 |  4332 |     2   (0)| 00:00:01 |       |       |
|*  4 |    HASH JOIN              |                   |  3601 |   260K|  4880   (1)| 00:00:01 |       |       |
|   5 |     MERGE JOIN CARTESIAN  |                   |   180 |  5220 |     3   (0)| 00:00:01 |       |       |
|*  6 |      INDEX RANGE SCAN     | PS_PSTREESELECT05 |     2 |    22 |     1   (0)| 00:00:01 |       |       |
|   7 |      BUFFER SORT          |                   |    90 |  1620 |     2   (0)| 00:00:01 |       |       |
|*  8 |       INDEX RANGE SCAN    | PS_PSTREESELECT10 |    90 |  1620 |     1   (0)| 00:00:01 |       |       |
|   9 |     PARTITION RANGE SINGLE|                   | 39970 |  1756K|  4877   (1)| 00:00:01 |     1 |     1 |
|* 10 |      TABLE ACCESS FULL    | PS_LEDGER         | 39970 |  1756K|  4877   (1)| 00:00:01 |     1 |     1 |
---------------------------------------------------------------------------------------------------------------

Query Block Name / Object Alias (identified by operation id):
-------------------------------------------------------------

   1 - SEL$1
   3 - SEL$1 / L2@SEL$1
   6 - SEL$1 / L1@SEL$1
   8 - SEL$1 / L@SEL$1
  10 - SEL$1 / A@SEL$1

Outline Data
-------------

  /*+
      BEGIN_OUTLINE_DATA
      USE_HASH_AGGREGATION(@"SEL$1")
      SWAP_JOIN_INPUTS(@"SEL$1" "L2"@"SEL$1")
      USE_HASH(@"SEL$1" "L2"@"SEL$1")
      USE_HASH(@"SEL$1" "A"@"SEL$1")
      USE_MERGE_CARTESIAN(@"SEL$1" "L"@"SEL$1")
      LEADING(@"SEL$1" "L1"@"SEL$1" "L"@"SEL$1" "A"@"SEL$1" "L2"@"SEL$1")
      INDEX(@"SEL$1" "L2"@"SEL$1" ("PSTREESELECT10"."SELECTOR_NUM" "PSTREESELECT10"."TREE_NODE_NUM"
              "PSTREESELECT10"."RANGE_FROM_10"))
      FULL(@"SEL$1" "A"@"SEL$1")
      INDEX(@"SEL$1" "L"@"SEL$1" ("PSTREESELECT10"."SELECTOR_NUM" "PSTREESELECT10"."TREE_NODE_NUM"
              "PSTREESELECT10"."RANGE_FROM_10"))
      INDEX(@"SEL$1" "L1"@"SEL$1" ("PSTREESELECT05"."SELECTOR_NUM" "PSTREESELECT05"."TREE_NODE_NUM"
              "PSTREESELECT05"."RANGE_FROM_05"))
      OUTLINE_LEAF(@"SEL$1")
      ALL_ROWS
      DB_VERSION('19.1.0')
      OPTIMIZER_FEATURES_ENABLE('19.1.0')
      IGNORE_OPTIM_EMBEDDED_HINTS
      END_OUTLINE_DATA
  */

Predicate Information (identified by operation id):
---------------------------------------------------

   2 - access("A"."ACCOUNT"="L2"."RANGE_FROM_10")
   3 - access("L2"."SELECTOR_NUM"=30984)
   4 - access("A"."BUSINESS_UNIT"="L1"."RANGE_FROM_05" AND "A"."CHARTFIELD1"="L"."RANGE_FROM_10")
   6 - access("L1"."SELECTOR_NUM"=30982)
   8 - access("L"."SELECTOR_NUM"=30985)
  10 - filter("A"."ACCOUNTING_PERIOD"<=6 AND "A"."LEDGER"='ACTUALS' AND "A"."FISCAL_YEAR"=2018 AND
              "A"."ACCOUNTING_PERIOD">=1 AND "A"."CURRENCY_CD"='GBP')

Query Block Registry:
---------------------

  <q o="2" f="y"><n><![CDATA[SEL$1]]></n><f><h><t><![CDATA[A]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![C
        DATA[L]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![CDATA[L1]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![C
        DATA[L2]]></t><s><![CDATA[SEL$1]]></s></h></f></q>


71 rows selected.

Elapsed: 00:00:00.11
22:00:01 SQL> REM spool off
22:00:01 SQL> 
22:00:01 SQL> REM 2019
22:00:01 SQL> explain plan for
22:00:01   2  SELECT L.TREE_NODE_NUM,L2.TREE_NODE_NUM,SUM(A.POSTED_TOTAL_AMT)
22:00:01   3  FROM   PS_LEDGER A
22:00:01   4  ,      PSTREESELECT05 L1
22:00:01   5  ,      PSTREESELECT10 L
22:00:01   6  ,      PSTREESELECT10 L2
22:00:01   7  WHERE  A.LEDGER='ACTUALS'
22:00:01   8  AND    A.FISCAL_YEAR=2019
22:00:01   9  AND    A.ACCOUNTING_PERIOD BETWEEN 1 AND 6
22:00:01  10  AND    L1.SELECTOR_NUM=30982 AND A.BUSINESS_UNIT=L1.RANGE_FROM_05
22:00:01  11  AND    L.SELECTOR_NUM=30985 AND A.CHARTFIELD1=L.RANGE_FROM_10
22:00:01  12  AND    L2.SELECTOR_NUM=30984 AND A.ACCOUNT=L2.RANGE_FROM_10
22:00:01  13  AND    A.CURRENCY_CD='GBP'
22:00:01  14  GROUP BY L.TREE_NODE_NUM,L2.TREE_NODE_NUM
22:00:01  15  /

Explained.

Elapsed: 00:00:00.24
22:00:02 SQL> @@xp
22:00:02 SQL> REM xp.sql
22:00:02 SQL> REM spool xp
22:00:02 SQL> REM set pages 9999 lines 200 autotrace off
22:00:02 SQL> select * from table(dbms_xplan.display(null,null,'ADVANCED -PROJECTION +ADAPTIVE'));

PLAN_TABLE_OUTPUT
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Plan hash value: 4006930814

----------------------------------------------------------------------------------------------------------------------
| Id  | Operation                        | Name              | Rows  | Bytes | Cost (%CPU)| Time     | Pstart| Pstop |
----------------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT                 |                   |  1088 | 88128 |   674   (2)| 00:00:01 |       |       |
|   1 |  HASH GROUP BY                   |                   |  1088 | 88128 |   674   (2)| 00:00:01 |       |       |
|*  2 |   HASH JOIN                      |                   |  1088 | 88128 |   673   (2)| 00:00:01 |       |       |
|*  3 |    INDEX RANGE SCAN              | PS_PSTREESELECT10 |   228 |  4332 |     2   (0)| 00:00:01 |       |       |
|*  4 |    HASH JOIN                     |                   |  4767 |   288K|   671   (2)| 00:00:01 |       |       |
|   5 |     MERGE JOIN CARTESIAN         |                   |   180 |  5220 |     3   (0)| 00:00:01 |       |       |
|*  6 |      INDEX RANGE SCAN            | PS_PSTREESELECT05 |     2 |    22 |     1   (0)| 00:00:01 |       |       |
|   7 |      BUFFER SORT                 |                   |    90 |  1620 |     2   (0)| 00:00:01 |       |       |
|*  8 |       INDEX RANGE SCAN           | PS_PSTREESELECT10 |    90 |  1620 |     1   (0)| 00:00:01 |       |       |
|   9 |     PARTITION RANGE SINGLE       |                   | 52909 |  1705K|   668   (2)| 00:00:01 |     1 |     1 |
|* 10 |      MAT_VIEW REWRITE ACCESS FULL| MV_LEDGER_2020    | 52909 |  1705K|   668   (2)| 00:00:01 |     1 |     1 |
----------------------------------------------------------------------------------------------------------------------

Query Block Name / Object Alias (identified by operation id):
-------------------------------------------------------------

   1 - SEL$1E60250C
   3 - SEL$1E60250C / L2@SEL$1
   6 - SEL$1E60250C / L1@SEL$1
   8 - SEL$1E60250C / L@SEL$1
  10 - SEL$1E60250C / MV_LEDGER_2020@SEL$5272D5B4

Outline Data
-------------

  /*+
      BEGIN_OUTLINE_DATA
      USE_HASH_AGGREGATION(@"SEL$1E60250C")
      SWAP_JOIN_INPUTS(@"SEL$1E60250C" "L2"@"SEL$1")
      USE_HASH(@"SEL$1E60250C" "L2"@"SEL$1")
      USE_HASH(@"SEL$1E60250C" "MV_LEDGER_2020"@"SEL$5272D5B4")
      USE_MERGE_CARTESIAN(@"SEL$1E60250C" "L"@"SEL$1")
      LEADING(@"SEL$1E60250C" "L1"@"SEL$1" "L"@"SEL$1" "MV_LEDGER_2020"@"SEL$5272D5B4" "L2"@"SEL$1")
      INDEX(@"SEL$1E60250C" "L2"@"SEL$1" ("PSTREESELECT10"."SELECTOR_NUM" "PSTREESELECT10"."TREE_NODE_NUM"
              "PSTREESELECT10"."RANGE_FROM_10"))
      FULL(@"SEL$1E60250C" "MV_LEDGER_2020"@"SEL$5272D5B4")
      INDEX(@"SEL$1E60250C" "L"@"SEL$1" ("PSTREESELECT10"."SELECTOR_NUM" "PSTREESELECT10"."TREE_NODE_NUM"
              "PSTREESELECT10"."RANGE_FROM_10"))
      INDEX(@"SEL$1E60250C" "L1"@"SEL$1" ("PSTREESELECT05"."SELECTOR_NUM" "PSTREESELECT05"."TREE_NODE_NUM"
              "PSTREESELECT05"."RANGE_FROM_05"))
      OUTLINE(@"SEL$1")
      REWRITE(@"SEL$1" "MV_LEDGER_2020")
      OUTLINE(@"SEL$68C95E58")
      REWRITE(@"SEL$68C95E58" "MV_LEDGER_2020")
      OUTLINE_LEAF(@"SEL$1E60250C")
      ALL_ROWS
      DB_VERSION('19.1.0')
      OPTIMIZER_FEATURES_ENABLE('19.1.0')
      IGNORE_OPTIM_EMBEDDED_HINTS
      END_OUTLINE_DATA
  */

Predicate Information (identified by operation id):
---------------------------------------------------

   2 - access("MV_LEDGER_2020"."ACCOUNT"="L2"."RANGE_FROM_10")
   3 - access("L2"."SELECTOR_NUM"=30984)
   4 - access("MV_LEDGER_2020"."BUSINESS_UNIT"="L1"."RANGE_FROM_05" AND
              "MV_LEDGER_2020"."CHARTFIELD1"="L"."RANGE_FROM_10")
   6 - access("L1"."SELECTOR_NUM"=30982)
   8 - access("L"."SELECTOR_NUM"=30985)
  10 - filter("MV_LEDGER_2020"."ACCOUNTING_PERIOD"<=6 AND "MV_LEDGER_2020"."FISCAL_YEAR"=2019 AND
              "MV_LEDGER_2020"."ACCOUNTING_PERIOD">=1)

Query Block Registry:
---------------------

  <q o="6" f="y" h="y"><n><![CDATA[SEL$1E60250C]]></n><p><![CDATA[SEL$68C95E58]]></p><i><o><t>MV</t><v><![CDATA[
        MV_LEDGER_2020]]></v></o></i><f><h><t><![CDATA[L]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![CDATA[L1]]></t><s>
        <![CDATA[SEL$1]]></s></h><h><t><![CDATA[L2]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![CDATA[MV_LEDGER_2020]]><
        /t><s><![CDATA[SEL$5272D5B4]]></s></h></f></q>
  <q o="2"><n><![CDATA[SEL$1]]></n><f><h><t><![CDATA[A]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![CDATA[L]]></t>
        <s><![CDATA[SEL$1]]></s></h><h><t><![CDATA[L1]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![CDATA[L2]]></t><s><![
        CDATA[SEL$1]]></s></h></f></q>
  <q o="6" h="y"><n><![CDATA[SEL$68C95E58]]></n><p><![CDATA[SEL$1]]></p><i><o><t>MV</t><v><![CDATA[MV_LEDGER_202
        0]]></v></o></i><f><h><t><![CDATA[L]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![CDATA[L1]]></t><s><![CDATA[SEL$
        1]]></s></h><h><t><![CDATA[L2]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![CDATA[MV_LEDGER_2020]]></t><s><![CDAT
        A[SEL$5272D5B4]]></s></h></f></q>


84 rows selected.

Elapsed: 00:00:00.15
22:00:02 SQL> REM spool off
22:00:02 SQL> 
22:00:02 SQL> REM 2020
22:00:02 SQL> explain plan for
22:00:02   2  SELECT L.TREE_NODE_NUM,L2.TREE_NODE_NUM,SUM(A.POSTED_TOTAL_AMT)
22:00:02   3  FROM   PS_LEDGER A
22:00:02   4  ,      PSTREESELECT05 L1
22:00:02   5  ,      PSTREESELECT10 L
22:00:02   6  ,      PSTREESELECT10 L2
22:00:02   7  WHERE  A.LEDGER='ACTUALS'
22:00:02   8  AND    A.FISCAL_YEAR=2020
22:00:02   9  AND    (A.ACCOUNTING_PERIOD BETWEEN 1 AND 6)
22:00:02  10  AND    L1.SELECTOR_NUM=30982 AND A.BUSINESS_UNIT=L1.RANGE_FROM_05
22:00:02  11  AND    L.SELECTOR_NUM=30985 AND A.CHARTFIELD1=L.RANGE_FROM_10
22:00:02  12  AND    L2.SELECTOR_NUM=30984 AND A.ACCOUNT=L2.RANGE_FROM_10
22:00:02  13  AND    A.CURRENCY_CD='GBP'
22:00:02  14  GROUP BY L.TREE_NODE_NUM,L2.TREE_NODE_NUM
22:00:02  15  /

Explained.

Elapsed: 00:00:00.14
22:00:02 SQL> @@xp
22:00:02 SQL> REM xp.sql
22:00:02 SQL> REM spool xp
22:00:02 SQL> REM set pages 9999 lines 200 autotrace off
22:00:02 SQL> select * from table(dbms_xplan.display(null,null,'ADVANCED -PROJECTION +ADAPTIVE'));

PLAN_TABLE_OUTPUT
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Plan hash value: 1780139226

---------------------------------------------------------------------------------------------------------------
| Id  | Operation                 | Name              | Rows  | Bytes | Cost (%CPU)| Time     | Pstart| Pstop |
---------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT          |                   |   477 | 44361 |  4483   (1)| 00:00:01 |       |       |
|   1 |  HASH GROUP BY            |                   |   477 | 44361 |  4483   (1)| 00:00:01 |       |       |
|*  2 |   HASH JOIN               |                   |   477 | 44361 |  4482   (1)| 00:00:01 |       |       |
|*  3 |    INDEX RANGE SCAN       | PS_PSTREESELECT10 |   228 |  4332 |     2   (0)| 00:00:01 |       |       |
|*  4 |    HASH JOIN              |                   |  2090 |   151K|  4479   (1)| 00:00:01 |       |       |
|   5 |     MERGE JOIN CARTESIAN  |                   |   180 |  5220 |     3   (0)| 00:00:01 |       |       |
|*  6 |      INDEX RANGE SCAN     | PS_PSTREESELECT05 |     2 |    22 |     1   (0)| 00:00:01 |       |       |
|   7 |      BUFFER SORT          |                   |    90 |  1620 |     2   (0)| 00:00:01 |       |       |
|*  8 |       INDEX RANGE SCAN    | PS_PSTREESELECT10 |    90 |  1620 |     1   (0)| 00:00:01 |       |       |
|   9 |     PARTITION RANGE SINGLE|                   | 23179 |  1018K|  4476   (1)| 00:00:01 |     3 |     3 |
|* 10 |      TABLE ACCESS FULL    | PS_LEDGER         | 23179 |  1018K|  4476   (1)| 00:00:01 |     3 |     3 |
---------------------------------------------------------------------------------------------------------------

Query Block Name / Object Alias (identified by operation id):
-------------------------------------------------------------

   1 - SEL$1
   3 - SEL$1 / L2@SEL$1
   6 - SEL$1 / L1@SEL$1
   8 - SEL$1 / L@SEL$1
  10 - SEL$1 / A@SEL$1

Outline Data
-------------

  /*+
      BEGIN_OUTLINE_DATA
      USE_HASH_AGGREGATION(@"SEL$1")
      SWAP_JOIN_INPUTS(@"SEL$1" "L2"@"SEL$1")
      USE_HASH(@"SEL$1" "L2"@"SEL$1")
      USE_HASH(@"SEL$1" "A"@"SEL$1")
      USE_MERGE_CARTESIAN(@"SEL$1" "L"@"SEL$1")
      LEADING(@"SEL$1" "L1"@"SEL$1" "L"@"SEL$1" "A"@"SEL$1" "L2"@"SEL$1")
      INDEX(@"SEL$1" "L2"@"SEL$1" ("PSTREESELECT10"."SELECTOR_NUM" "PSTREESELECT10"."TREE_NODE_NUM"
              "PSTREESELECT10"."RANGE_FROM_10"))
      FULL(@"SEL$1" "A"@"SEL$1")
      INDEX(@"SEL$1" "L"@"SEL$1" ("PSTREESELECT10"."SELECTOR_NUM" "PSTREESELECT10"."TREE_NODE_NUM"
              "PSTREESELECT10"."RANGE_FROM_10"))
      INDEX(@"SEL$1" "L1"@"SEL$1" ("PSTREESELECT05"."SELECTOR_NUM" "PSTREESELECT05"."TREE_NODE_NUM"
              "PSTREESELECT05"."RANGE_FROM_05"))
      OUTLINE_LEAF(@"SEL$1")
      ALL_ROWS
      DB_VERSION('19.1.0')
      OPTIMIZER_FEATURES_ENABLE('19.1.0')
      IGNORE_OPTIM_EMBEDDED_HINTS
      END_OUTLINE_DATA
  */

Predicate Information (identified by operation id):
---------------------------------------------------

   2 - access("A"."ACCOUNT"="L2"."RANGE_FROM_10")
   3 - access("L2"."SELECTOR_NUM"=30984)
   4 - access("A"."BUSINESS_UNIT"="L1"."RANGE_FROM_05" AND "A"."CHARTFIELD1"="L"."RANGE_FROM_10")
   6 - access("L1"."SELECTOR_NUM"=30982)
   8 - access("L"."SELECTOR_NUM"=30985)
  10 - filter("A"."ACCOUNTING_PERIOD"<=6 AND "A"."LEDGER"='ACTUALS' AND "A"."FISCAL_YEAR"=2020 AND
              "A"."ACCOUNTING_PERIOD">=1 AND "A"."CURRENCY_CD"='GBP')

Query Block Registry:
---------------------

  <q o="2" f="y"><n><![CDATA[SEL$1]]></n><f><h><t><![CDATA[A]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![C
        DATA[L]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![CDATA[L1]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![C
        DATA[L2]]></t><s><![CDATA[SEL$1]]></s></h></f></q>


71 rows selected.

Elapsed: 00:00:00.13
22:00:02 SQL> REM spool off
22:00:02 SQL> set autotrace off
22:00:02 SQL> 
22:00:02 SQL> @@mvtrc
22:00:02 SQL> REM mvtrc.sql
22:00:02 SQL> disconnect
Disconnected from Oracle Database 19c Enterprise Edition Release 19.0.0.0.0 - Production
Version 19.9.0.0.0
22:00:02 SQL> connect scott/tiger@oracle_pdb
Connected.
22:00:02 SQL> 
22:00:02 SQL> column name format a20
22:00:02 SQL> column value format a70
22:00:02 SQL> select * from v$diag_info where name like '%Trace%';

   INST_ID NAME                 VALUE                                                                      CON_ID
---------- -------------------- ---------------------------------------------------------------------- ----------
         1 Diag Trace           /u01/app/oracle/diag/rdbms/oracle/oracle/trace                                  0
         1 Default Trace File   /u01/app/oracle/diag/rdbms/oracle/oracle/trace/oracle_ora_7802.trc              0

Elapsed: 00:00:00.00
22:00:02 SQL> 
22:00:02 SQL> alter session set tracefile_identifier=PCT;

Session altered.

Elapsed: 00:00:00.00
22:00:02 SQL> alter session set sql_trace = true;

Session altered.

Elapsed: 00:00:00.01
22:00:02 SQL> exec dbms_mview.refresh(list=>'MV_LEDGER_2019',method=>'P',atomic_refresh=>FALSE);
BEGIN dbms_mview.refresh(list=>'MV_LEDGER_2019',method=>'P',atomic_refresh=>FALSE); END;

*
ERROR at line 1:
ORA-20000: ORA-01031: insufficient privileges
ORA-06512: at "SYS.DBMS_SNAPSHOT_KKXRCA", line 3020
ORA-06512: at "SYS.DBMS_IREFRESH", line 186
ORA-06512: at "SYS.DBMS_ISNAPSHOT", line 189
ORA-06512: at "SYS.DBMS_SNAPSHOT_KKXRCA", line 2852
ORA-06512: at "SYS.DBMS_SNAPSHOT_KKXRCA", line 3263
ORA-06512: at "SYS.DBMS_SNAPSHOT_KKXRCA", line 3295
ORA-06512: at "SYS.DBMS_SNAPSHOT", line 16
ORA-06512: at line 1


Elapsed: 00:00:00.02
22:00:02 SQL> exec dbms_mview.refresh(list=>'MV_LEDGER_2020',method=>'P',atomic_refresh=>FALSE);

PL/SQL procedure successfully completed.

Elapsed: 00:00:14.87
22:00:17 SQL> alter session set sql_trace = false;

Session altered.

Elapsed: 00:00:00.00
22:00:17 SQL> exec dbms_stats.gather_Table_stats(user,'MV_LEDGER_2019');
BEGIN dbms_stats.gather_Table_stats(user,'MV_LEDGER_2019'); END;

*
ERROR at line 1:
ORA-20000: Unable to analyze TABLE "SCOTT"."MV_LEDGER_2019", insufficient privileges or does not exist
ORA-06512: at "SYS.DBMS_STATS", line 40753
ORA-06512: at "SYS.DBMS_STATS", line 40026
ORA-06512: at "SYS.DBMS_STATS", line 40185
ORA-06512: at "SYS.DBMS_STATS", line 40734
ORA-06512: at line 1


Elapsed: 00:00:00.02
22:00:17 SQL> exec dbms_stats.gather_Table_stats(user,'MV_LEDGER_2020');

PL/SQL procedure successfully completed.

Elapsed: 00:00:38.03
22:00:55 SQL> 
22:00:55 SQL> @@mvvol
22:00:55 SQL> REM mvvol.sql
22:00:55 SQL> 
22:00:55 SQL> set autotrace off
22:00:55 SQL> break on table_name skip 1 on partition_name
22:00:55 SQL> column table_name format a15
22:00:55 SQL> column column_name format a20
22:00:55 SQL> column mview_name format a20
22:00:55 SQL> column partition_position format 999 heading 'Part|Pos'
22:00:55 SQL> column subpartition_position format 999 heading 'Sub-|Part|Pos'
22:00:55 SQL> column partition_name format a20
22:00:55 SQL> column subpartition_name format a25
22:00:55 SQL> column num_rows format 9999999
22:00:55 SQL> column num_distinct heading 'Num|Distinct' format 9999999
22:00:55 SQL> column num_buckets heading 'Num|Buckets'	format 9999
22:00:55 SQL> column blocks format 99999
22:00:55 SQL> column rpb format 999.9 heading 'Rows|per|Block'
22:00:55 SQL> SELECT MVIEW_NAME, STALENESS, LAST_REFRESH_TYPE, COMPILE_STATE FROM USER_MVIEWS ORDER BY MVIEW_NAME;

MVIEW_NAME           STALENESS           LAST_REF COMPILE_STATE
-------------------- ------------------- -------- -------------------
MV_LEDGER_2020       FRESH               FAST_PCT VALID

Elapsed: 00:00:00.01
22:00:55 SQL> 
22:00:55 SQL> select count(*) from mv_ledger_2019;
select count(*) from mv_ledger_2019
                     *
ERROR at line 1:
ORA-00942: table or view does not exist


Elapsed: 00:00:00.00
22:00:55 SQL> select count(*) from mv_ledger_2020;

  COUNT(*)
----------
   1528980

Elapsed: 00:00:00.10
22:00:55 SQL> 
22:00:55 SQL> select a.table_name, a.partition_position, a.partition_name, a.subpartition_position, a.subpartition_name
22:00:55   2  , a.num_rows, a.blocks, a.num_rows/nullif(a.blocks,0) rpb
22:00:55   3  , COALESCE(c.compression, b.compression) compression
22:00:55   4  , COALESCE(c.compress_for, b.compress_for) compress_for
22:00:55   5  from user_tab_statistics a
22:00:55   6  	LEFT OUTER JOIN user_tab_partitions b
22:00:55   7  	  ON a.table_name = b.table_name
22:00:55   8  	  AND a.partition_name = b.partition_name
22:00:55   9  	LEFT OUTER JOIN user_tab_subpartitions c
22:00:55  10  	  ON a.table_name = c.table_name
22:00:55  11  	  AND a.partition_name = c.partition_name
22:00:55  12  	  AND a.subpartition_name = c.subpartition_name
22:00:55  13  where a.table_name like '%LEDGER%'
22:00:55  14  order by a.table_name, a.partition_position, a.subpartition_position nulls first
22:00:55  15  /

                                          Sub-                                             Rows
                Part                      Part                                              per
TABLE_NAME       Pos PARTITION_NAME        Pos SUBPARTITION_NAME         NUM_ROWS BLOCKS  Block COMPRESS COMPRESS_FOR
--------------- ---- -------------------- ---- ------------------------- -------- ------ ------ -------- ------------------------------
MV_LEDGER_2020     1 LEDGER_2019                                           946825   3173  298.4 ENABLED  BASIC
                   2 LEDGER_2020                                           582155   1926  302.3 ENABLED  BASIC
                                                                          1528980   5099  299.9

PS_LEDGER          1 LEDGER_2018                                          1100000  17893   61.5 ENABLED  BASIC
                   2 LEDGER_2019                                          1100000  17892   61.5 ENABLED  BASIC
                   3 LEDGER_2020                                           637915  16456   38.8 DISABLED
                   4 LEDGER_2021                                           100000   2559   39.1 DISABLED
                                                                          2937915  54800   53.6


8 rows selected.

Elapsed: 00:00:00.04
22:00:55 SQL> 
22:00:55 SQL> column extension format a40
22:00:55 SQL> select s.table_name, s.column_name, s.num_distinct, s.num_buckets, s.histogram, s.last_analyzed, e.extension
22:00:55   2  from user_tab_col_statistics s
22:00:55   3  	LEFT OUTER JOIN user_stat_extensions e
22:00:55   4  	ON e.table_name = s.table_name
22:00:55   5  	AND e.extension_name = s.column_name
22:00:55   6  where s.table_name like 'MV_LEDGER%'
22:00:55   7  order by 1,2
22:00:55   8  ;

                                          Num     Num
TABLE_NAME      COLUMN_NAME          Distinct Buckets HISTOGRAM       LAST_ANAL EXTENSION
--------------- -------------------- -------- ------- --------------- --------- ----------------------------------------
MV_LEDGER_2020  ACCOUNT                   999       1 NONE            15-NOV-20
                ACCOUNTING_PERIOD          15       1 NONE            15-NOV-20
                BUSINESS_UNIT               2       2 FREQUENCY       15-NOV-20
                CHARTFIELD1               999       1 NONE            15-NOV-20
                FISCAL_YEAR                 2       1 NONE            15-NOV-20
                POSTED_TOTAL_AMT      1528980       1 NONE            15-NOV-20
                SYS_NC00007$                2       1 NONE            15-NOV-20 (SYS_OP_MAP_NONNULL("BUSINESS_UNIT"))
                SYS_NC00008$              999       1 NONE            15-NOV-20 (SYS_OP_MAP_NONNULL("ACCOUNT"))
                SYS_NC00009$              999       1 NONE            15-NOV-20 (SYS_OP_MAP_NONNULL("CHARTFIELD1"))
                SYS_NC00010$                2       1 NONE            15-NOV-20 (SYS_OP_MAP_NONNULL("FISCAL_YEAR"))
                SYS_NC00011$               15       1 NONE            15-NOV-20 (SYS_OP_MAP_NONNULL("ACCOUNTING_PERIOD")
                                                                                )



11 rows selected.

Elapsed: 00:00:00.02
22:00:55 SQL> column extension format a40
22:00:55 SQL> select s.table_name, s.partition_name, s.column_name, s.num_distinct, s.num_buckets, s.histogram, s.last_analyzed, e.extension
22:00:55   2  from user_part_col_statistics s
22:00:55   3  	LEFT OUTER JOIN user_stat_extensions e
22:00:55   4  	ON e.table_name = s.table_name
22:00:55   5  	AND e.extension_name = s.column_name
22:00:55   6  where s.table_name like 'MV_LEDGER%'
22:00:55   7  order by 1,2
22:00:55   8  ;

                                                               Num     Num
TABLE_NAME      PARTITION_NAME       COLUMN_NAME          Distinct Buckets HISTOGRAM       LAST_ANAL EXTENSION
--------------- -------------------- -------------------- -------- ------- --------------- --------- ----------------------------------------
MV_LEDGER_2020  LEDGER_2019          BUSINESS_UNIT               2       2 FREQUENCY       15-NOV-20
                                     ACCOUNT                   999       1 NONE            15-NOV-20
                                     CHARTFIELD1               999       1 NONE            15-NOV-20
                                     FISCAL_YEAR                 1       1 NONE            15-NOV-20
                                     ACCOUNTING_PERIOD          15       1 NONE            15-NOV-20
                                     POSTED_TOTAL_AMT       946825       1 NONE            15-NOV-20
                                     SYS_NC00007$                2       1 NONE            15-NOV-20 (SYS_OP_MAP_NONNULL("BUSINESS_UNIT"))
                                     SYS_NC00008$              999       1 NONE            15-NOV-20 (SYS_OP_MAP_NONNULL("ACCOUNT"))
                                     SYS_NC00009$              999       1 NONE            15-NOV-20 (SYS_OP_MAP_NONNULL("CHARTFIELD1"))
                                     SYS_NC00010$                1       1 NONE            15-NOV-20 (SYS_OP_MAP_NONNULL("FISCAL_YEAR"))
                                     SYS_NC00011$               15       1 NONE            15-NOV-20 (SYS_OP_MAP_NONNULL("ACCOUNTING_PERIOD")
                                                                                                     )

                LEDGER_2020          BUSINESS_UNIT               2       2 FREQUENCY       15-NOV-20
                                     ACCOUNT                   999       1 NONE            15-NOV-20
                                     CHARTFIELD1               999       1 NONE            15-NOV-20
                                     FISCAL_YEAR                 1       1 NONE            15-NOV-20
                                     ACCOUNTING_PERIOD           8       1 NONE            15-NOV-20
                                     POSTED_TOTAL_AMT       582155       1 NONE            15-NOV-20
                                     SYS_NC00007$                2       1 NONE            15-NOV-20 (SYS_OP_MAP_NONNULL("BUSINESS_UNIT"))
                                     SYS_NC00008$              999       1 NONE            15-NOV-20 (SYS_OP_MAP_NONNULL("ACCOUNT"))
                                     SYS_NC00009$              999       1 NONE            15-NOV-20 (SYS_OP_MAP_NONNULL("CHARTFIELD1"))
                                     SYS_NC00010$                1       1 NONE            15-NOV-20 (SYS_OP_MAP_NONNULL("FISCAL_YEAR"))
                                     SYS_NC00011$                8       1 NONE            15-NOV-20 (SYS_OP_MAP_NONNULL("ACCOUNTING_PERIOD")
                                                                                                     )



22 rows selected.

Elapsed: 00:00:00.03
22:00:55 SQL> 
22:00:55 SQL> column extension format a40
22:00:55 SQL> select s.table_name, s.subpartition_name, s.column_name, s.num_distinct, s.num_buckets, s.histogram, s.last_analyzed, e.extension
22:00:55   2  from user_subpart_col_statistics s
22:00:55   3  	LEFT OUTER JOIN user_stat_extensions e
22:00:55   4  	ON e.table_name = s.table_name
22:00:55   5  	AND e.extension_name = s.column_name
22:00:55   6  where s.table_name like 'MV_LEDGER%'
22:00:55   7  order by 1,2
22:00:55   8  ;

no rows selected

Elapsed: 00:00:00.00
22:00:55 SQL> @@mvsql
22:00:55 SQL> REM mvsql.sql
22:00:55 SQL> set autotrace off
22:00:55 SQL> 
22:00:55 SQL> REM 2018
22:00:55 SQL> set lines 200 pages 999
22:00:55 SQL> explain plan for
22:00:55   2  SELECT L.TREE_NODE_NUM,L2.TREE_NODE_NUM,SUM(A.POSTED_TOTAL_AMT)
22:00:55   3  FROM   PS_LEDGER A
22:00:55   4  ,      PSTREESELECT05 L1
22:00:55   5  ,      PSTREESELECT10 L
22:00:55   6  ,      PSTREESELECT10 L2
22:00:55   7  WHERE  A.LEDGER='ACTUALS'
22:00:55   8  AND    A.FISCAL_YEAR=2018
22:00:55   9  AND    A.ACCOUNTING_PERIOD BETWEEN 1 AND 6
22:00:55  10  AND    L1.SELECTOR_NUM=30982 AND A.BUSINESS_UNIT=L1.RANGE_FROM_05
22:00:55  11  AND    L.SELECTOR_NUM=30985 AND A.CHARTFIELD1=L.RANGE_FROM_10
22:00:55  12  AND    L2.SELECTOR_NUM=30984 AND A.ACCOUNT=L2.RANGE_FROM_10
22:00:55  13  AND    A.CURRENCY_CD='GBP'
22:00:55  14  GROUP BY L.TREE_NODE_NUM,L2.TREE_NODE_NUM
22:00:55  15  /

Explained.

Elapsed: 00:00:00.16
22:00:55 SQL> @@xp
22:00:55 SQL> REM xp.sql
22:00:55 SQL> REM spool xp
22:00:55 SQL> REM set pages 9999 lines 200 autotrace off
22:00:55 SQL> select * from table(dbms_xplan.display(null,null,'ADVANCED -PROJECTION +ADAPTIVE'));

PLAN_TABLE_OUTPUT
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Plan hash value: 1780139226

---------------------------------------------------------------------------------------------------------------
| Id  | Operation                 | Name              | Rows  | Bytes | Cost (%CPU)| Time     | Pstart| Pstop |
---------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT          |                   |   822 | 76446 |  4883   (1)| 00:00:01 |       |       |
|   1 |  HASH GROUP BY            |                   |   822 | 76446 |  4883   (1)| 00:00:01 |       |       |
|*  2 |   HASH JOIN               |                   |   822 | 76446 |  4882   (1)| 00:00:01 |       |       |
|*  3 |    INDEX RANGE SCAN       | PS_PSTREESELECT10 |   228 |  4332 |     2   (0)| 00:00:01 |       |       |
|*  4 |    HASH JOIN              |                   |  3601 |   260K|  4880   (1)| 00:00:01 |       |       |
|   5 |     MERGE JOIN CARTESIAN  |                   |   180 |  5220 |     3   (0)| 00:00:01 |       |       |
|*  6 |      INDEX RANGE SCAN     | PS_PSTREESELECT05 |     2 |    22 |     1   (0)| 00:00:01 |       |       |
|   7 |      BUFFER SORT          |                   |    90 |  1620 |     2   (0)| 00:00:01 |       |       |
|*  8 |       INDEX RANGE SCAN    | PS_PSTREESELECT10 |    90 |  1620 |     1   (0)| 00:00:01 |       |       |
|   9 |     PARTITION RANGE SINGLE|                   | 39970 |  1756K|  4877   (1)| 00:00:01 |     1 |     1 |
|* 10 |      TABLE ACCESS FULL    | PS_LEDGER         | 39970 |  1756K|  4877   (1)| 00:00:01 |     1 |     1 |
---------------------------------------------------------------------------------------------------------------

Query Block Name / Object Alias (identified by operation id):
-------------------------------------------------------------

   1 - SEL$1
   3 - SEL$1 / L2@SEL$1
   6 - SEL$1 / L1@SEL$1
   8 - SEL$1 / L@SEL$1
  10 - SEL$1 / A@SEL$1

Outline Data
-------------

  /*+
      BEGIN_OUTLINE_DATA
      USE_HASH_AGGREGATION(@"SEL$1")
      SWAP_JOIN_INPUTS(@"SEL$1" "L2"@"SEL$1")
      USE_HASH(@"SEL$1" "L2"@"SEL$1")
      USE_HASH(@"SEL$1" "A"@"SEL$1")
      USE_MERGE_CARTESIAN(@"SEL$1" "L"@"SEL$1")
      LEADING(@"SEL$1" "L1"@"SEL$1" "L"@"SEL$1" "A"@"SEL$1" "L2"@"SEL$1")
      INDEX(@"SEL$1" "L2"@"SEL$1" ("PSTREESELECT10"."SELECTOR_NUM" "PSTREESELECT10"."TREE_NODE_NUM"
              "PSTREESELECT10"."RANGE_FROM_10"))
      FULL(@"SEL$1" "A"@"SEL$1")
      INDEX(@"SEL$1" "L"@"SEL$1" ("PSTREESELECT10"."SELECTOR_NUM" "PSTREESELECT10"."TREE_NODE_NUM"
              "PSTREESELECT10"."RANGE_FROM_10"))
      INDEX(@"SEL$1" "L1"@"SEL$1" ("PSTREESELECT05"."SELECTOR_NUM" "PSTREESELECT05"."TREE_NODE_NUM"
              "PSTREESELECT05"."RANGE_FROM_05"))
      OUTLINE_LEAF(@"SEL$1")
      ALL_ROWS
      DB_VERSION('19.1.0')
      OPTIMIZER_FEATURES_ENABLE('19.1.0')
      IGNORE_OPTIM_EMBEDDED_HINTS
      END_OUTLINE_DATA
  */

Predicate Information (identified by operation id):
---------------------------------------------------

   2 - access("A"."ACCOUNT"="L2"."RANGE_FROM_10")
   3 - access("L2"."SELECTOR_NUM"=30984)
   4 - access("A"."BUSINESS_UNIT"="L1"."RANGE_FROM_05" AND "A"."CHARTFIELD1"="L"."RANGE_FROM_10")
   6 - access("L1"."SELECTOR_NUM"=30982)
   8 - access("L"."SELECTOR_NUM"=30985)
  10 - filter("A"."ACCOUNTING_PERIOD"<=6 AND "A"."LEDGER"='ACTUALS' AND "A"."FISCAL_YEAR"=2018 AND
              "A"."ACCOUNTING_PERIOD">=1 AND "A"."CURRENCY_CD"='GBP')

Query Block Registry:
---------------------

  <q o="2" f="y"><n><![CDATA[SEL$1]]></n><f><h><t><![CDATA[A]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![C
        DATA[L]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![CDATA[L1]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![C
        DATA[L2]]></t><s><![CDATA[SEL$1]]></s></h></f></q>


71 rows selected.

Elapsed: 00:00:00.16
22:00:56 SQL> REM spool off
22:00:56 SQL> 
22:00:56 SQL> REM 2019
22:00:56 SQL> explain plan for
22:00:56   2  SELECT L.TREE_NODE_NUM,L2.TREE_NODE_NUM,SUM(A.POSTED_TOTAL_AMT)
22:00:56   3  FROM   PS_LEDGER A
22:00:56   4  ,      PSTREESELECT05 L1
22:00:56   5  ,      PSTREESELECT10 L
22:00:56   6  ,      PSTREESELECT10 L2
22:00:56   7  WHERE  A.LEDGER='ACTUALS'
22:00:56   8  AND    A.FISCAL_YEAR=2019
22:00:56   9  AND    A.ACCOUNTING_PERIOD BETWEEN 1 AND 6
22:00:56  10  AND    L1.SELECTOR_NUM=30982 AND A.BUSINESS_UNIT=L1.RANGE_FROM_05
22:00:56  11  AND    L.SELECTOR_NUM=30985 AND A.CHARTFIELD1=L.RANGE_FROM_10
22:00:56  12  AND    L2.SELECTOR_NUM=30984 AND A.ACCOUNT=L2.RANGE_FROM_10
22:00:56  13  AND    A.CURRENCY_CD='GBP'
22:00:56  14  GROUP BY L.TREE_NODE_NUM,L2.TREE_NODE_NUM
22:00:56  15  /

Explained.

Elapsed: 00:00:00.25
22:00:56 SQL> @@xp
22:00:56 SQL> REM xp.sql
22:00:56 SQL> REM spool xp
22:00:56 SQL> REM set pages 9999 lines 200 autotrace off
22:00:56 SQL> select * from table(dbms_xplan.display(null,null,'ADVANCED -PROJECTION +ADAPTIVE'));

PLAN_TABLE_OUTPUT
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Plan hash value: 4006930814

----------------------------------------------------------------------------------------------------------------------
| Id  | Operation                        | Name              | Rows  | Bytes | Cost (%CPU)| Time     | Pstart| Pstop |
----------------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT                 |                   |  1415 |   111K|   877   (2)| 00:00:01 |       |       |
|   1 |  HASH GROUP BY                   |                   |  1415 |   111K|   877   (2)| 00:00:01 |       |       |
|*  2 |   HASH JOIN                      |                   |  1415 |   111K|   876   (2)| 00:00:01 |       |       |
|*  3 |    INDEX RANGE SCAN              | PS_PSTREESELECT10 |   228 |  4332 |     2   (0)| 00:00:01 |       |       |
|*  4 |    HASH JOIN                     |                   |  6199 |   375K|   874   (2)| 00:00:01 |       |       |
|   5 |     MERGE JOIN CARTESIAN         |                   |   180 |  5220 |     3   (0)| 00:00:01 |       |       |
|*  6 |      INDEX RANGE SCAN            | PS_PSTREESELECT05 |     2 |    22 |     1   (0)| 00:00:01 |       |       |
|   7 |      BUFFER SORT                 |                   |    90 |  1620 |     2   (0)| 00:00:01 |       |       |
|*  8 |       INDEX RANGE SCAN           | PS_PSTREESELECT10 |    90 |  1620 |     1   (0)| 00:00:01 |       |       |
|   9 |     PARTITION RANGE SINGLE       |                   | 68808 |  2217K|   871   (2)| 00:00:01 |     1 |     1 |
|* 10 |      MAT_VIEW REWRITE ACCESS FULL| MV_LEDGER_2020    | 68808 |  2217K|   871   (2)| 00:00:01 |     1 |     1 |
----------------------------------------------------------------------------------------------------------------------

Query Block Name / Object Alias (identified by operation id):
-------------------------------------------------------------

   1 - SEL$1E60250C
   3 - SEL$1E60250C / L2@SEL$1
   6 - SEL$1E60250C / L1@SEL$1
   8 - SEL$1E60250C / L@SEL$1
  10 - SEL$1E60250C / MV_LEDGER_2020@SEL$5272D5B4

Outline Data
-------------

  /*+
      BEGIN_OUTLINE_DATA
      USE_HASH_AGGREGATION(@"SEL$1E60250C")
      SWAP_JOIN_INPUTS(@"SEL$1E60250C" "L2"@"SEL$1")
      USE_HASH(@"SEL$1E60250C" "L2"@"SEL$1")
      USE_HASH(@"SEL$1E60250C" "MV_LEDGER_2020"@"SEL$5272D5B4")
      USE_MERGE_CARTESIAN(@"SEL$1E60250C" "L"@"SEL$1")
      LEADING(@"SEL$1E60250C" "L1"@"SEL$1" "L"@"SEL$1" "MV_LEDGER_2020"@"SEL$5272D5B4" "L2"@"SEL$1")
      INDEX(@"SEL$1E60250C" "L2"@"SEL$1" ("PSTREESELECT10"."SELECTOR_NUM" "PSTREESELECT10"."TREE_NODE_NUM"
              "PSTREESELECT10"."RANGE_FROM_10"))
      FULL(@"SEL$1E60250C" "MV_LEDGER_2020"@"SEL$5272D5B4")
      INDEX(@"SEL$1E60250C" "L"@"SEL$1" ("PSTREESELECT10"."SELECTOR_NUM" "PSTREESELECT10"."TREE_NODE_NUM"
              "PSTREESELECT10"."RANGE_FROM_10"))
      INDEX(@"SEL$1E60250C" "L1"@"SEL$1" ("PSTREESELECT05"."SELECTOR_NUM" "PSTREESELECT05"."TREE_NODE_NUM"
              "PSTREESELECT05"."RANGE_FROM_05"))
      OUTLINE(@"SEL$1")
      REWRITE(@"SEL$1" "MV_LEDGER_2020")
      OUTLINE(@"SEL$68C95E58")
      REWRITE(@"SEL$68C95E58" "MV_LEDGER_2020")
      OUTLINE_LEAF(@"SEL$1E60250C")
      ALL_ROWS
      DB_VERSION('19.1.0')
      OPTIMIZER_FEATURES_ENABLE('19.1.0')
      IGNORE_OPTIM_EMBEDDED_HINTS
      END_OUTLINE_DATA
  */

Predicate Information (identified by operation id):
---------------------------------------------------

   2 - access("MV_LEDGER_2020"."ACCOUNT"="L2"."RANGE_FROM_10")
   3 - access("L2"."SELECTOR_NUM"=30984)
   4 - access("MV_LEDGER_2020"."BUSINESS_UNIT"="L1"."RANGE_FROM_05" AND
              "MV_LEDGER_2020"."CHARTFIELD1"="L"."RANGE_FROM_10")
   6 - access("L1"."SELECTOR_NUM"=30982)
   8 - access("L"."SELECTOR_NUM"=30985)
  10 - filter("MV_LEDGER_2020"."ACCOUNTING_PERIOD"<=6 AND "MV_LEDGER_2020"."ACCOUNTING_PERIOD">=1 AND
              "MV_LEDGER_2020"."FISCAL_YEAR"=2019)

Query Block Registry:
---------------------

  <q o="6" f="y" h="y"><n><![CDATA[SEL$1E60250C]]></n><p><![CDATA[SEL$68C95E58]]></p><i><o><t>MV</t><v><![CDATA[
        MV_LEDGER_2020]]></v></o></i><f><h><t><![CDATA[L]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![CDATA[L1]]></t><s>
        <![CDATA[SEL$1]]></s></h><h><t><![CDATA[L2]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![CDATA[MV_LEDGER_2020]]><
        /t><s><![CDATA[SEL$5272D5B4]]></s></h></f></q>
  <q o="2"><n><![CDATA[SEL$1]]></n><f><h><t><![CDATA[A]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![CDATA[L]]></t>
        <s><![CDATA[SEL$1]]></s></h><h><t><![CDATA[L1]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![CDATA[L2]]></t><s><![
        CDATA[SEL$1]]></s></h></f></q>
  <q o="6" h="y"><n><![CDATA[SEL$68C95E58]]></n><p><![CDATA[SEL$1]]></p><i><o><t>MV</t><v><![CDATA[MV_LEDGER_202
        0]]></v></o></i><f><h><t><![CDATA[L]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![CDATA[L1]]></t><s><![CDATA[SEL$
        1]]></s></h><h><t><![CDATA[L2]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![CDATA[MV_LEDGER_2020]]></t><s><![CDAT
        A[SEL$5272D5B4]]></s></h></f></q>


84 rows selected.

Elapsed: 00:00:00.15
22:00:56 SQL> REM spool off
22:00:56 SQL> 
22:00:56 SQL> REM 2020
22:00:56 SQL> explain plan for
22:00:56   2  SELECT L.TREE_NODE_NUM,L2.TREE_NODE_NUM,SUM(A.POSTED_TOTAL_AMT)
22:00:56   3  FROM   PS_LEDGER A
22:00:56   4  ,      PSTREESELECT05 L1
22:00:56   5  ,      PSTREESELECT10 L
22:00:56   6  ,      PSTREESELECT10 L2
22:00:56   7  WHERE  A.LEDGER='ACTUALS'
22:00:56   8  AND    A.FISCAL_YEAR=2020
22:00:56   9  AND    (A.ACCOUNTING_PERIOD BETWEEN 1 AND 6)
22:00:56  10  AND    L1.SELECTOR_NUM=30982 AND A.BUSINESS_UNIT=L1.RANGE_FROM_05
22:00:56  11  AND    L.SELECTOR_NUM=30985 AND A.CHARTFIELD1=L.RANGE_FROM_10
22:00:56  12  AND    L2.SELECTOR_NUM=30984 AND A.ACCOUNT=L2.RANGE_FROM_10
22:00:56  13  AND    A.CURRENCY_CD='GBP'
22:00:56  14  GROUP BY L.TREE_NODE_NUM,L2.TREE_NODE_NUM
22:00:56  15  /

Explained.

Elapsed: 00:00:00.28
22:00:56 SQL> @@xp
22:00:56 SQL> REM xp.sql
22:00:56 SQL> REM spool xp
22:00:56 SQL> REM set pages 9999 lines 200 autotrace off
22:00:56 SQL> select * from table(dbms_xplan.display(null,null,'ADVANCED -PROJECTION +ADAPTIVE'));

PLAN_TABLE_OUTPUT
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Plan hash value: 4006930814

------------------------------------------------------------------------------------------------------------------------------
| Id  | Operation                        | Name              | Rows  | Bytes |TempSpc| Cost (%CPU)| Time     | Pstart| Pstop |
------------------------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT                 |                   | 11542 |   912K|       |   760   (2)| 00:00:01 |       |       |
|   1 |  HASH GROUP BY                   |                   | 11542 |   912K|  1064K|   760   (2)| 00:00:01 |       |       |
|*  2 |   HASH JOIN                      |                   | 11542 |   912K|       |   538   (2)| 00:00:01 |       |       |
|*  3 |    INDEX RANGE SCAN              | PS_PSTREESELECT10 |   228 |  4332 |       |     2   (0)| 00:00:01 |       |       |
|*  4 |    HASH JOIN                     |                   | 50573 |  3062K|       |   536   (2)| 00:00:01 |       |       |
|   5 |     MERGE JOIN CARTESIAN         |                   |   180 |  5220 |       |     3   (0)| 00:00:01 |       |       |
|*  6 |      INDEX RANGE SCAN            | PS_PSTREESELECT05 |     2 |    22 |       |     1   (0)| 00:00:01 |       |       |
|   7 |      BUFFER SORT                 |                   |    90 |  1620 |       |     2   (0)| 00:00:01 |       |       |
|*  8 |       INDEX RANGE SCAN           | PS_PSTREESELECT10 |    90 |  1620 |       |     1   (0)| 00:00:01 |       |       |
|   9 |     PARTITION RANGE SINGLE       |                   |   561K|    17M|       |   531   (2)| 00:00:01 |     2 |     2 |
|* 10 |      MAT_VIEW REWRITE ACCESS FULL| MV_LEDGER_2020    |   561K|    17M|       |   531   (2)| 00:00:01 |     2 |     2 |
------------------------------------------------------------------------------------------------------------------------------

Query Block Name / Object Alias (identified by operation id):
-------------------------------------------------------------

   1 - SEL$1E60250C
   3 - SEL$1E60250C / L2@SEL$1
   6 - SEL$1E60250C / L1@SEL$1
   8 - SEL$1E60250C / L@SEL$1
  10 - SEL$1E60250C / MV_LEDGER_2020@SEL$5272D5B4

Outline Data
-------------

  /*+
      BEGIN_OUTLINE_DATA
      USE_HASH_AGGREGATION(@"SEL$1E60250C")
      SWAP_JOIN_INPUTS(@"SEL$1E60250C" "L2"@"SEL$1")
      USE_HASH(@"SEL$1E60250C" "L2"@"SEL$1")
      USE_HASH(@"SEL$1E60250C" "MV_LEDGER_2020"@"SEL$5272D5B4")
      USE_MERGE_CARTESIAN(@"SEL$1E60250C" "L"@"SEL$1")
      LEADING(@"SEL$1E60250C" "L1"@"SEL$1" "L"@"SEL$1" "MV_LEDGER_2020"@"SEL$5272D5B4" "L2"@"SEL$1")
      INDEX(@"SEL$1E60250C" "L2"@"SEL$1" ("PSTREESELECT10"."SELECTOR_NUM" "PSTREESELECT10"."TREE_NODE_NUM"
              "PSTREESELECT10"."RANGE_FROM_10"))
      FULL(@"SEL$1E60250C" "MV_LEDGER_2020"@"SEL$5272D5B4")
      INDEX(@"SEL$1E60250C" "L"@"SEL$1" ("PSTREESELECT10"."SELECTOR_NUM" "PSTREESELECT10"."TREE_NODE_NUM"
              "PSTREESELECT10"."RANGE_FROM_10"))
      INDEX(@"SEL$1E60250C" "L1"@"SEL$1" ("PSTREESELECT05"."SELECTOR_NUM" "PSTREESELECT05"."TREE_NODE_NUM"
              "PSTREESELECT05"."RANGE_FROM_05"))
      OUTLINE(@"SEL$1")
      REWRITE(@"SEL$1" "MV_LEDGER_2020")
      OUTLINE(@"SEL$68C95E58")
      REWRITE(@"SEL$68C95E58" "MV_LEDGER_2020")
      OUTLINE_LEAF(@"SEL$1E60250C")
      ALL_ROWS
      DB_VERSION('19.1.0')
      OPTIMIZER_FEATURES_ENABLE('19.1.0')
      IGNORE_OPTIM_EMBEDDED_HINTS
      END_OUTLINE_DATA
  */

Predicate Information (identified by operation id):
---------------------------------------------------

   2 - access("MV_LEDGER_2020"."ACCOUNT"="L2"."RANGE_FROM_10")
   3 - access("L2"."SELECTOR_NUM"=30984)
   4 - access("MV_LEDGER_2020"."BUSINESS_UNIT"="L1"."RANGE_FROM_05" AND
              "MV_LEDGER_2020"."CHARTFIELD1"="L"."RANGE_FROM_10")
   6 - access("L1"."SELECTOR_NUM"=30982)
   8 - access("L"."SELECTOR_NUM"=30985)
  10 - filter("MV_LEDGER_2020"."ACCOUNTING_PERIOD"<=6 AND "MV_LEDGER_2020"."ACCOUNTING_PERIOD">=1 AND
              "MV_LEDGER_2020"."FISCAL_YEAR"=2020)

Query Block Registry:
---------------------

  <q o="6" f="y" h="y"><n><![CDATA[SEL$1E60250C]]></n><p><![CDATA[SEL$68C95E58]]></p><i><o><t>MV</t><v><![CDATA[MV_LEDGE
        R_2020]]></v></o></i><f><h><t><![CDATA[L]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![CDATA[L1]]></t><s><![CDATA[SEL$1]]
        ></s></h><h><t><![CDATA[L2]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![CDATA[MV_LEDGER_2020]]></t><s><![CDATA[SEL$5272D
        5B4]]></s></h></f></q>
  <q o="2"><n><![CDATA[SEL$1]]></n><f><h><t><![CDATA[A]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![CDATA[L]]></t><s><![CD
        ATA[SEL$1]]></s></h><h><t><![CDATA[L1]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![CDATA[L2]]></t><s><![CDATA[SEL$1]]></
        s></h></f></q>
  <q o="6" h="y"><n><![CDATA[SEL$68C95E58]]></n><p><![CDATA[SEL$1]]></p><i><o><t>MV</t><v><![CDATA[MV_LEDGER_2020]]></v>
        </o></i><f><h><t><![CDATA[L]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![CDATA[L1]]></t><s><![CDATA[SEL$1]]></s></h><h><
        t><![CDATA[L2]]></t><s><![CDATA[SEL$1]]></s></h><h><t><![CDATA[MV_LEDGER_2020]]></t><s><![CDATA[SEL$5272D5B4]]></s></h
        ></f></q>


84 rows selected.

Elapsed: 00:00:00.15
22:00:56 SQL> REM spool off
22:00:56 SQL> set autotrace off
22:00:56 SQL> @@mvcap
22:00:56 SQL> REM mvcap.sql
22:00:56 SQL> REM spool mvcap
22:00:56 SQL> set autotrace off
22:00:56 SQL> create table MV_CAPABILITIES_TABLE
22:00:56   2  (
22:00:56   3  	statement_id	  varchar(30) ,
22:00:56   4  	mvowner 	  varchar(30) ,
22:00:56   5  	mvname		  varchar(30) ,
22:00:56   6  	capability_name   varchar(30) ,
22:00:56   7  	possible	  character(1) ,
22:00:56   8  	related_text	  varchar(2000) ,
22:00:56   9  	related_num	  number ,
22:00:56  10  	msgno		  integer ,
22:00:56  11  	msgtxt		  varchar(2000) ,
22:00:56  12  	seq		  number
22:00:56  13  ) ;
create table MV_CAPABILITIES_TABLE
             *
ERROR at line 1:
ORA-00955: name is already used by an existing object


Elapsed: 00:00:00.01
22:00:57 SQL> 
22:00:57 SQL> truncate table MV_CAPABILITIES_TABLE;

Table truncated.

Elapsed: 00:00:00.05
22:00:57 SQL> EXECUTE DBMS_MVIEW.EXPLAIN_MVIEW ('SCOTT.MV_LEDGER_2019');
BEGIN DBMS_MVIEW.EXPLAIN_MVIEW ('SCOTT.MV_LEDGER_2019'); END;

*
ERROR at line 1:
ORA-20000: ORA-01031: insufficient privileges
ORA-06512: at "SYS.DBMS_IREFRESH", line 186
ORA-06512: at "SYS.DBMS_SNAPSHOT_KKXRCA", line 3952
ORA-06512: at "SYS.DBMS_SNAPSHOT", line 234
ORA-06512: at line 1


Elapsed: 00:00:00.00
22:00:57 SQL> EXECUTE DBMS_MVIEW.EXPLAIN_MVIEW ('SCOTT.MV_LEDGER_2020');

PL/SQL procedure successfully completed.

Elapsed: 00:00:00.06
22:00:57 SQL> break on mvname skip 1
22:00:57 SQL> column rel_text format a20
22:00:57 SQL> column msgtxt format a60
22:00:57 SQL> SELECT mvname, capability_name,  possible, SUBSTR(related_text,1,20) AS rel_text, SUBSTR(msgtxt,1,60) AS msgtxt
22:00:57   2  FROM MV_CAPABILITIES_TABLE
22:00:57   3  WHERE mvname like 'MV_LEDGER_20%'
22:00:57   4  ORDER BY mvname, seq;

MVNAME                         CAPABILITY_NAME                P REL_TEXT             MSGTXT
------------------------------ ------------------------------ - -------------------- ------------------------------------------------------------
MV_LEDGER_2020                 PCT                            Y
                               REFRESH_COMPLETE               Y
                               REFRESH_FAST                   Y
                               REWRITE                        Y
                               PCT_TABLE                      Y PS_LEDGER
                               REFRESH_FAST_AFTER_INSERT      N SCOTT.PS_LEDGER      the detail table does not have a materialized view log
                               REFRESH_FAST_AFTER_ONETAB_DML  N POSTED_TOTAL_AMT     SUM(expr) without COUNT(expr)
                               REFRESH_FAST_AFTER_ONETAB_DML  N                      see the reason why REFRESH_FAST_AFTER_INSERT is disabled
                               REFRESH_FAST_AFTER_ONETAB_DML  N                      COUNT(*) is not present in the select list
                               REFRESH_FAST_AFTER_ONETAB_DML  N                      SUM(expr) without COUNT(expr)
                               REFRESH_FAST_AFTER_ANY_DML     N                      see the reason why REFRESH_FAST_AFTER_ONETAB_DML is disabled
                               REFRESH_FAST_PCT               Y
                               REWRITE_FULL_TEXT_MATCH        Y
                               REWRITE_PARTIAL_TEXT_MATCH     Y
                               REWRITE_GENERAL                Y
                               REWRITE_PCT                    Y
                               PCT_TABLE_REWRITE              Y PS_LEDGER


17 rows selected.

Elapsed: 00:00:00.01
22:00:57 SQL> 
22:00:57 SQL> REM spool off
22:00:57 SQL> SPOOL OFF
